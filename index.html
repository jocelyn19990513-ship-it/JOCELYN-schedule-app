<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>我的日程清单 · Project 50</title>

  <!-- PWA 相关：保持你原来的图标 -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="app-icon-v2.png" />

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 6px 0; /* 减少整体上下留白 */
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Noto Sans SC", sans-serif;
      background: #f5f5f7;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      color: #111827;
    }

    .app {
      width: 95%;
      max-width: 540px;
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.12);
      padding: 14px 16px 18px;
    }

    .app-header {
      padding: 4px 2px 6px;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 8px;
    }

    .app-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .app-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 20px;
      margin: 0;
    }

    .badge-logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #f472b6, #a855f7);
    }

    .app-subtitle {
      margin-top: 3px;
      font-size: 11px;
      color: #6b7280;
    }

    .app-meta {
      text-align: right;
      font-size: 10px;
      color: #9ca3af;
      margin-top: 2px;
    }

    /* 顶部 Tab：只保留图标，不要圆圈背景 */
    .tab-header {
      margin-top: 10px;
      margin-bottom: 6px;
      padding: 0;
      background: transparent;
      display: flex;
      gap: 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    .tab-btn {
      flex: 1;
      border: none;
      background: transparent;
      padding: 4px 0 6px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      position: relative;
    }

    .tab-icon-wrap {
      width: auto;
      height: auto;
      background: transparent;
      border-radius: 0;
      box-shadow: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tab-icon-wrap img {
      width: 22px;
      height: 22px;
      border-radius: 0;
      display: block;
      opacity: 0.6;
    }

    /* 当前激活的 tab：图标更亮，并在底部加一条小粉线 */
    .tab-btn.active .tab-icon-wrap img {
      opacity: 1;
    }

    .tab-btn.active::after {
      content: "";
      position: absolute;
      left: 20%;
      right: 20%;
      bottom: 0;
      height: 2px;
      border-radius: 999px;
      background: linear-gradient(90deg, #f472b6, #a855f7);
    }

    .tab-section { display: none; }
    .tab-section.active { display: block; }

    h2.section-title {
      font-size: 16px;
      margin: 0 0 4px;
    }

    .section-desc {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    /* 通用输入样式 */
    input[type="text"],
    input[type="number"],
    input[type="date"],
    textarea,
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font-size: 14px;
      outline: none;
      background: #f9fafb;
    }
    input:focus,
    textarea:focus,
    select:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.18);
      background: #ffffff;
    }

    button { font-family: inherit; }

    .primary-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      background: linear-gradient(135deg, #6366f1, #ec4899);
      color: #ffffff;
      white-space: nowrap;
    }
    .primary-btn:active { transform: scale(0.97); }

    .small-btn {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      border: none;
      cursor: pointer;
      white-space: nowrap;
    }

    .badge-soft {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      background: #f3f4f6;
      color: #4b5563;
    }

    .row-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .hint {
      font-size: 11px;
      color: #9ca3af;
    }

    .card {
      border-radius: 14px;
      padding: 8px 10px 10px;
      background: #f9fafb;
      box-shadow: inset 0 0 0 1px #e5e7eb;
      margin-bottom: 6px;
    }

    @media (max-width: 400px) {
      .tab-header { gap: 6px; }
    }

    /* Project 50 */
    .p50-date-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .p50-date-row input[type="date"] { flex: 1; }

    .p50-rules {
      border-radius: 12px;
      background: #ffffff;
      padding: 6px 8px;
      max-height: 220px;
      overflow-y: auto;
      box-shadow: 0 1px 3px rgba(148, 163, 184, 0.25);
    }

    .p50-rule-item {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      padding: 5px 0;
      border-bottom: 1px solid #f3f4f6;
      font-size: 13px;
    }
    .p50-rule-item:last-child { border-bottom: none; }

    .p50-summary {
      font-size: 13px;
      color: #4b5563;
      margin-top: 6px;
    }

    .p50-note textarea {
      min-height: 70px;
      resize: vertical;
      font-size: 13px;
    }

    /* 通用日历 */
    .calendar-wrapper {
      margin-top: 8px;
      border-radius: 14px;
      background: #f9fafb;
      padding: 8px;
      box-shadow: inset 0 0 0 1px #e5e7eb;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .calendar-title {
      font-size: 13px;
      color: #4b5563;
    }
    .cal-nav {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .cal-nav-btn {
      border: none;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 12px;
      cursor: pointer;
      background: #e5e7eb;
      color: #374151;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      font-size: 11px;
    }
    .cal-cell {
      min-height: 32px;
      border-radius: 7px;
      padding: 2px 3px;
      text-align: center;
      background: #e5e7eb;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .cal-weekday {
      font-weight: 600;
      background: transparent;
      color: #6b7280;
    }
    .cal-empty { background: transparent; }

    .cal-day-num { font-size: 11px; }

    .cal-minutes {
      font-size: 10px;
      color: #374151;
    }

    /* 紫色强度等级（Project 50 完成度 / 专注等级） */
    .cal-level-0 { background: #e5e7eb; color: #4b5563; }
    .cal-level-1 { background: #f5f3ff; color: #5b21b6; }
    .cal-level-2 { background: #e0e7ff; color: #4338ca; }
    .cal-level-3 { background: #c7d2fe; color: #3730a3; }
    .cal-level-4 { background: #a855f7; color: #f9fafb; }
  </style>
</head>
<body>
<div class="app">
  <header class="app-header">
    <div class="app-title-row">
      <h1 class="app-title">
        <span class="badge-logo">50</span>
        <span>我的日程清单</span>
      </h1>
      <div class="badge-soft">v1.0.2</div>
    </div>
    <div class="app-subtitle">
      Project 50 打卡 · To-Do 专注 · 重要事项 · 体重 & 运动（数据仅保存在本地）
    </div>
    <div class="app-meta">designed by Jiayu Hou</div>
  </header>

  <!-- 顶部 Tab：只显示 PNG 图标 -->
  <div class="tab-header">
    <button class="tab-btn active" data-target="tab-project50" title="Project 50">
      <span class="tab-icon-wrap">
        <img src="icon-project50.png" alt="Project 50" />
      </span>
    </button>
    <button class="tab-btn" data-target="tab-todo" title="待办事项">
      <span class="tab-icon-wrap">
        <img src="icon-todo.png" alt="To-Do" />
      </span>
    </button>
    <button class="tab-btn" data-target="tab-important" title="每日重要事项">
      <span class="tab-icon-wrap">
        <img src="icon-important.png" alt="Important" />
      </span>
    </button>
    <button class="tab-btn" data-target="tab-weight" title="体重 & 运动">
      <span class="tab-icon-wrap">
        <img src="icon-weight.png" alt="Weight" />
      </span>
    </button>
    <button class="tab-btn" data-target="tab-about" title="使用说明">
      <span class="tab-icon-wrap">
        <img src="icon-about.png" alt="About" />
      </span>
    </button>
  </div>

  <!-- -------------------- Project 50 MODULE -------------------- -->
<section id="tab-project50" class="tab-section active">

  <!-- 每日 Challenge -->
  <div class="card">
    <h2 class="section-title">每日 Challenge</h2>
    <div class="section-desc">
      根据 Project 50（easy 模式）打卡，7 条固定规则，每天复盘执行情况。
    </div>

    <div class="p50-date-row">
      <input type="date" id="p50-date" />
      <button class="small-btn primary-btn" id="p50-today-btn">跳到今天</button>
    </div>

    <div class="p50-rules" id="p50-rules"></div>
    <div class="p50-summary" id="p50-summary"></div>
  </div>

  <!-- Notes -->
  <div class="card p50-note">
    <div class="row-between">
      <span class="hint">记录今天的挑战行程 / 感受 / 复盘：</span>
      <span class="badge-soft">仅本地可见</span>
    </div>
    <textarea id="p50-note-input"
      placeholder="例如：7:30 起床，锻炼 30 分钟，阅读 6 页……"></textarea>
  </div>

  <!-- Project 50 日历 -->
  <div class="calendar-wrapper">
    <div class="calendar-header">
      <div class="calendar-title" id="p50-calendar-title">Project 50 完成情况</div>
      <div class="cal-nav">
        <button class="cal-nav-btn" id="p50-cal-prev">‹</button>
        <button class="cal-nav-btn" id="p50-cal-next">›</button>
      </div>
    </div>
    <div class="hint">深浅表示当天完成规则数量（越深完成越多）。</div>
    <div class="calendar-grid" id="p50-calendar-grid"></div>
  </div>

</section>

<script>
/* 获取今日 YYYY-MM-DD */
function getTodayStr() {
  const d = new Date();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return d.getFullYear() + "-" + m + "-" + day;
}

/* 月份平移工具 */
function shiftMonth(date, delta) {
  return new Date(date.getFullYear(), date.getMonth() + delta, 1);
}

/* ---------------- Project 50 数据结构 ---------------- */
const P50_RULES = [
  { id: "wake", text: "早上 8 点前起床" },
  { id: "read", text: "每天阅读书籍至少 5 页" },
  { id: "exercise", text: "每天锻炼至少 30 分钟" },
  { id: "nosoda", text: "不喝碳酸饮料" },
  { id: "morning_routine", text: "完成晨起行程（不玩手机，可听音乐）" },
  { id: "plan_day", text: "记录今天的计划" },
  { id: "reflect", text: "简单复盘：今天是否比昨天更好？" }
];

const P50_STORAGE_KEY = "project50_data_v1";
let p50Data = {};  // { dateStr: { rules:{id:bool}, note:string } }

const p50DateInput = document.getElementById("p50-date");
const p50TodayBtn = document.getElementById("p50-today-btn");
const p50RulesEl = document.getElementById("p50-rules");
const p50SummaryEl = document.getElementById("p50-summary");
const p50NoteInput = document.getElementById("p50-note-input");

const p50CalendarTitleEl = document.getElementById("p50-calendar-title");
const p50CalendarGridEl = document.getElementById("p50-calendar-grid");
const p50CalPrevBtn = document.getElementById("p50-cal-prev");
const p50CalNextBtn = document.getElementById("p50-cal-next");

let p50CalMonth;

/* 载入本地存储 */
function loadP50Data() {
  const raw = localStorage.getItem(P50_STORAGE_KEY);
  if (raw) {
    try { p50Data = JSON.parse(raw) || {}; }
    catch { p50Data = {}; }
  }
}

/* 保存 */
function saveP50Data() {
  localStorage.setItem(P50_STORAGE_KEY, JSON.stringify(p50Data));
}

/* 获取某天结构 */
function getP50DayData(dateStr) {
  if (!p50Data[dateStr]) {
    p50Data[dateStr] = { rules: {}, note: "" };
  }
  return p50Data[dateStr];
}

/* ---------------- 项目渲染 ---------------- */
function renderP50Day() {
  const dateStr = p50DateInput.value || getTodayStr();
  p50DateInput.value = dateStr;

  const dayData = getP50DayData(dateStr);
  const rulesState = dayData.rules || {};

  p50RulesEl.innerHTML = "";
  let doneCount = 0;

  P50_RULES.forEach(rule => {
    const item = document.createElement("div");
    item.className = "p50-rule-item";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = !!rulesState[rule.id];

    cb.addEventListener("change", () => {
      const d = getP50DayData(p50DateInput.value);
      d.rules[rule.id] = cb.checked;
      saveP50Data();
      renderP50Calendar();
    });

    if (cb.checked) doneCount++;

    const label = document.createElement("div");
    label.textContent = rule.text;

    item.appendChild(cb);
    item.appendChild(label);
    p50RulesEl.appendChild(item);
  });

  p50SummaryEl.textContent =
    `今日完成情况： ${doneCount} / ${P50_RULES.length} 条已完成`;

  p50NoteInput.value = dayData.note || "";
}

/* 日历渲染 */
function renderP50Calendar() {
  const base = p50CalMonth || new Date();
  const year = base.getFullYear();
  const month = base.getMonth(); // 0–11

  p50CalendarTitleEl.textContent = `Project 50 日历 · ${year} 年 ${month + 1} 月`;

  const countByDay = {};
  Object.keys(p50Data).forEach(dateStr => {
    const d = new Date(dateStr);
    if (d.getFullYear() === year && d.getMonth() === month) {
      const day = d.getDate();
      const rules = p50Data[dateStr].rules || {};
      let count = 0;
      P50_RULES.forEach(r => { if (rules[r.id]) count++; });
      countByDay[day] = count;
    }
  });

  const firstDay = new Date(year, month, 1);
  const firstWeekday = firstDay.getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  p50CalendarGridEl.innerHTML = "";

  /* 星期行 */
  ["日", "一", "二", "三", "四", "五", "六"].forEach(w => {
    const cell = document.createElement("div");
    cell.className = "cal-cell cal-weekday";
    cell.textContent = w;
    p50CalendarGridEl.appendChild(cell);
  });

  /* 空白格 */
  for (let i = 0; i < firstWeekday; i++) {
    const empty = document.createElement("div");
    empty.className = "cal-cell cal-empty";
    p50CalendarGridEl.appendChild(empty);
  }

  /* 日期格 */
  for (let day = 1; day <= daysInMonth; day++) {
    const cell = document.createElement("div");
    const count = countByDay[day] || 0;

    let level = "cal-level-0";
    if (count >= 7) level = "cal-level-4";
    else if (count >= 5) level = "cal-level-3";
    else if (count >= 3) level = "cal-level-2";
    else if (count >= 1) level = "cal-level-1";

    cell.className = "cal-cell " + level;

    const num = document.createElement("div");
    num.className = "cal-day-num";
    num.textContent = day;

    cell.appendChild(num);
    p50CalendarGridEl.appendChild(cell);
  }
}

/* 笔记实时保存 */
p50NoteInput.addEventListener("input", () => {
  const dateStr = p50DateInput.value || getTodayStr();
  const d = getP50DayData(dateStr);
  d.note = p50NoteInput.value;
  saveP50Data();
});

/* 点击切换日期 */
p50DateInput.addEventListener("change", renderP50Day);

/* 跳到今天 */
p50TodayBtn.addEventListener("click", () => {
  p50DateInput.value = getTodayStr();
  p50CalMonth = new Date();
  p50CalMonth.setDate(1);
  renderP50Day();
  renderP50Calendar();
});

/* 月份切换按钮 */
p50CalPrevBtn.addEventListener("click", () => {
  p50CalMonth = shiftMonth(p50CalMonth, -1);
  renderP50Calendar();
});
p50CalNextBtn.addEventListener("click", () => {
  p50CalMonth = shiftMonth(p50CalMonth, 1);
  renderP50Calendar();
});
</script>

<!-- 在 body 里补充更多样式（合法可用） -->
<style>
  /* To-Do 栏目 */
  .todo-top-row {
    display: flex;
    gap: 8px;
    margin-bottom: 6px;
  }
  .todo-top-row input[type="text"] { flex: 2; }
  .todo-top-row select { flex: 1.2; }

  .todo-second-row {
    display: flex;
    gap: 8px;
    margin-bottom: 4px;
  }
  .todo-second-row input[type="date"] { flex: 1; }

  .todo-list {
    list-style: none;
    padding: 0;
    margin: 6px 0 0;
    max-height: 230px;
    overflow-y: auto;
  }
  .todo-empty {
    font-size: 13px;
    color: #9ca3af;
    text-align: center;
    margin-top: 6px;
  }

  .todo-item {
    padding: 6px 2px 4px;
    border-bottom: 1px solid #e5e7eb;
  }

  .todo-main-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 6px;
  }

  .todo-main {
    flex: 1;
    min-width: 0;
  }

  .todo-title {
    font-size: 14px;
    word-break: break-word;
  }
  .todo-title.done {
    text-decoration: line-through;
    color: #9ca3af;
  }

  .badge-category {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 11px;
    background: #fee2f2;
    color: #db2777;
    margin-right: 4px;
  }
  .todo-meta-text {
    font-size: 11px;
    color: #6b7280;
  }

  .done-row {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: #4b5563;
    white-space: nowrap;
  }

  .todo-actions-row {
    margin-top: 4px;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .focus-btn { background: #6366f1; color: #fff; }
  .focus-btn.stop { background: #ec4899; }
  .delete-btn { background: #ef4444; color: #fff; }
  .edit-btn { background: #f97316; color: #fff; }

  /* 重要事项 */
  .important-list {
    margin-top: 6px;
    max-height: 220px;
    overflow-y: auto;
    padding-left: 0;
    list-style: none;
  }
  .important-item {
    font-size: 13px;
    padding: 4px 2px;
    border-bottom: 1px solid #e5e7eb;
  }
  .important-top-row {
    display: flex;
    justify-content: space-between;
    gap: 6px;
    align-items: center;
  }
  .important-title { font-weight: 500; }

  .important-type-badge {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 999px;
    font-size: 10px;
    margin-right: 4px;
    margin-bottom: 2px;
    color: #fff;
  }

  /* 七种重要事项类型的颜色 */
  .imp-type-生活重要事项 { background: #f97373; }
  .imp-type-姨妈期 { background: #ec4899; }
  .imp-type-固定资金交付日 { background: #8b5cf6; }
  .imp-type-生日 { background: #facc15; color: #78350f; }
  .imp-type-纪念日 { background: #14b8a6; }
  .imp-type-工作重要事项 { background: #3b82f6; }
  .imp-type-学业重要事项 { background: #a855f7; }

  .important-note {
    font-size: 12px;
    color: #6b7280;
    margin-top: 2px;
  }
  .important-date {
    font-size: 11px;
    color: #9ca3af;
    margin-top: 1px;
  }

  /* 体重 & 运动 */
  .weight-row {
    display: flex;
    gap: 8px;
    margin-bottom: 6px;
  }
  .weight-row input[type="number"] { flex: 1; }
  .weight-row input[type="text"] { flex: 2; }

  .weight-list {
    list-style: none;
    padding: 0;
    margin: 6px 0 0;
    max-height: 160px;
    overflow-y: auto;
    font-size: 13px;
  }
  .weight-item {
    padding: 4px 2px;
    border-bottom: 1px solid #e5e7eb;
  }
  .weight-meta {
    font-size: 11px;
    color: #6b7280;
    margin-top: 1px;
  }

  canvas {
    max-width: 100%;
    border-radius: 10px;
    background: #f3f4f6;
  }

  /* 使用说明 */
  .about-list {
    font-size: 13px;
    color: #4b5563;
    padding-left: 1.2em;
  }

  /* 饼图图例 */
  .pie-legend {
    margin-top: 6px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px 10px;
    font-size: 11px;
    color: #4b5563;
  }
  .pie-legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .pie-legend-color {
    width: 10px;
    height: 10px;
    border-radius: 3px;
    background: #9ca3af;
  }
</style>

<!-- -------------------- To-Do 模块 -------------------- -->
<section id="tab-todo" class="tab-section">
  <div class="card">
    <h2 class="section-title">待办事项 & 专注记录</h2>
    <div class="section-desc">
      每天创建待办，按类别管理。点击“开始专注 / 结束专注”记录真实专注时间，可随时编辑内容。
    </div>

    <div class="todo-top-row">
      <input type="text" id="todo-title"
             placeholder="要做什么？例如：阅读《XXX》5 页" />
      <select id="todo-category">
        <option value="学习">学习</option>
        <option value="工作">工作</option>
        <option value="家庭">家庭</option>
        <option value="生活">生活</option>
        <option value="娱乐">娱乐</option>
        <option value="其他">其他</option>
      </select>
    </div>

    <div class="todo-second-row">
      <input type="date" id="todo-date" />
      <button class="primary-btn" id="todo-add-btn">添加待办</button>
    </div>
    <div class="hint">
      待办可以「编辑」标题和分类，之前累计的专注时间不会丢失。
    </div>

    <ul class="todo-list" id="todo-list"></ul>
    <div class="todo-empty" id="todo-empty">这天还没有待办，可以先添加一条～</div>
  </div>

  <!-- 按类别的日历（用色条显示当天有哪些类别） -->
  <div class="calendar-wrapper">
    <div class="calendar-header">
      <div class="calendar-title" id="focus-calendar-title">专注类别日历</div>
      <div class="cal-nav">
        <button class="cal-nav-btn" id="focus-cal-prev">‹</button>
        <button class="cal-nav-btn" id="focus-cal-next">›</button>
      </div>
    </div>
    <div class="hint">
      每天的色条表示当日完成任务的类别；点击某一天，会在上方列表显示当天任务。
    </div>
    <div class="calendar-grid" id="focus-calendar-grid"></div>
  </div>

  <!-- 专注时间统计饼图 -->
  <div class="card">
    <h2 class="section-title">专注时间统计</h2>
    <div class="section-desc">
      统计不同类别在最近一周 / 本月 / 本年的专注时间占比（仅统计有专注记录的任务）。
    </div>
    <div class="row-between" style="margin-bottom:6px;">
      <div>
        <button class="small-btn primary-btn" id="pie-week-btn">最近一周</button>
        <button class="small-btn" id="pie-month-btn">本月</button>
        <button class="small-btn" id="pie-year-btn">本年</button>
      </div>
      <span class="hint" id="pie-label">最近一周</span>
    </div>
    <canvas id="focus-pie" height="180"></canvas>
    <div class="pie-legend" id="pie-legend"></div>
  </div>
</section>

<!-- -------------------- 每日重要事项 -------------------- -->
<section id="tab-important" class="tab-section">
  <div class="card">
    <h2 class="section-title">每日重要事项</h2>
    <div class="section-desc">
      记录「生活重要事项 / 姨妈期 / 固定资金交付日 / 生日 / 纪念日 / 工作重要事项 / 学业重要事项」，
      在日历中一眼看到重要日子。
    </div>

    <div class="todo-second-row">
      <input type="date" id="important-date" />
      <select id="important-type">
        <option value="生活重要事项">生活重要事项</option>
        <option value="姨妈期">姨妈期</option>
        <option value="固定资金交付日">固定资金交付日</option>
        <option value="生日">生日</option>
        <option value="纪念日">纪念日</option>
        <option value="工作重要事项">工作重要事项</option>
        <option value="学业重要事项">学业重要事项</option>
      </select>
    </div>
    <input type="text" id="important-title"
           placeholder="事件标题，如：房租、某人生日、考试周开始…" />
    <textarea id="important-note"
      style="margin-top:6px;" placeholder="可选备注：地点、时间、准备事项等"></textarea>
    <div class="row-between" style="margin-top:6px;">
      <button class="primary-btn small-btn" id="important-add-btn">添加重要事项</button>
      <span class="hint">提示：生日 / 纪念日等建议每年自己查看日历。</span>
    </div>

    <ul class="important-list" id="important-list"></ul>
  </div>

  <div class="calendar-wrapper">
    <div class="calendar-header">
      <div class="calendar-title" id="important-calendar-title">重要事项日历</div>
      <div class="cal-nav">
        <button class="cal-nav-btn" id="important-cal-prev">‹</button>
        <button class="cal-nav-btn" id="important-cal-next">›</button>
      </div>
    </div>
    <div class="hint">
      不同颜色表示不同类型的重要事项；点击某一天，可以在上方列表看到这天的详情。
    </div>
    <div class="calendar-grid" id="important-calendar-grid"></div>
  </div>
</section>

<!-- -------------------- 体重 & 运动 -------------------- -->
<section id="tab-weight" class="tab-section">
  <div class="card">
    <h2 class="section-title">体重 & 运动记录</h2>
    <div class="section-desc">
      记录每天体重以及锻炼内容（如：慢跑 30 分钟、肩颈拉伸 15 分钟），
      用折线图查看当月体重变化。
    </div>

    <div class="todo-second-row">
      <input type="date" id="weight-date" />
      <input type="number" id="weight-value" placeholder="体重（kg）" step="0.1" />
    </div>
    <div class="weight-row">
      <input type="text" id="weight-exercise"
             placeholder="今天做了什么运动？例如：瑜伽 20 分钟" />
      <button class="primary-btn small-btn" id="weight-add-btn">添加记录</button>
    </div>
    <div class="hint">体重和运动记录仅保存在本机。</div>

    <ul class="weight-list" id="weight-list"></ul>
  </div>

  <div class="card">
    <h2 class="section-title">本月体重折线图</h2>
    <div class="section-desc">
      按日期查看本月体重变化趋势（仅展示当前月份有记录的日期）。
    </div>
    <canvas id="weight-chart" height="200"></canvas>
  </div>
</section>

<!-- -------------------- 使用说明（带刷新按钮） -------------------- -->
<section id="tab-about" class="tab-section">
  <div class="card">
    <div class="row-between">
      <h2 class="section-title">使用说明 & 更新</h2>
      <button class="small-btn primary-btn" id="force-reload-btn">
        刷新到最新版本
      </button>
    </div>

    <ul class="about-list">
      <li>所有数据都保存在当前设备浏览器的本地存储（localStorage），不会上传到服务器。</li>
      <li>不同设备 / 不同浏览器之间的数据不会自动同步，可以自行选择一台主设备长期使用。</li>
      <li>Project 50 用色块深浅表示每天完成了多少条规则，不需要额外填写数字。</li>
      <li>待办事项支持「编辑」，修改标题或类别不会清空专注分钟数。</li>
      <li>每日重要事项包括：生活重要事项、姨妈期、固定资金交付日、生日、纪念日、工作重要事项、学业重要事项，不同类型在日历上有不同颜色。</li>
      <li>体重 & 运动记录可长期使用，注意定期手动备份（例如截图）。</li>
    </ul>

    <p class="hint">
      如果发现页面样式错乱或功能没有更新，可以点击上方「刷新到最新版本」重新加载一次（不会删除你本机的数据）。
    </p>
  </div>
</section>

<script>
  /* 小工具：把 "YYYY-MM-DD" 转成本地 0 点的 Date，避免跨时区串位 */
  function parseYmd(str) {
    if (!str) return new Date();
    return new Date(str + "T00:00:00");
  }

  /* ---------------- Tab 切换 ---------------- */
  (function initTabs() {
    const tabButtons = document.querySelectorAll(".tab-btn");
    const sections = document.querySelectorAll(".tab-section");

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const targetId = btn.dataset.target;
        tabButtons.forEach((b) => b.classList.remove("active"));
        sections.forEach((sec) => sec.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(targetId).classList.add("active");
      });
    });
  })();

  /* ---------------- To-Do & 专注 ---------------- */
  const TODO_STORAGE_KEY = "todo_tasks_v1";
  let todoTasks = []; // {id,title,category,date,focusMinutes,isDone,isRunning,startTimeMs}

  const todoTitleInput = document.getElementById("todo-title");
  const todoCategorySelect = document.getElementById("todo-category");
  const todoDateInput = document.getElementById("todo-date");
  const todoAddBtn = document.getElementById("todo-add-btn");
  const todoListEl = document.getElementById("todo-list");
  const todoEmptyEl = document.getElementById("todo-empty");

  const focusCalendarTitleEl = document.getElementById("focus-calendar-title");
  const focusCalendarGridEl = document.getElementById("focus-calendar-grid");
  const focusCalPrevBtn = document.getElementById("focus-cal-prev");
  const focusCalNextBtn = document.getElementById("focus-cal-next");
  let focusCalMonth;

  function loadTodos() {
    try {
      const raw = localStorage.getItem(TODO_STORAGE_KEY);
      if (raw) todoTasks = JSON.parse(raw) || [];
    } catch (e) {
      todoTasks = [];
    }
  }

  function saveTodos() {
    localStorage.setItem(TODO_STORAGE_KEY, JSON.stringify(todoTasks));
  }

  function addTodo() {
    const title = todoTitleInput.value.trim();
    if (!title) return;
    const category = todoCategorySelect.value;
    const dateStr = todoDateInput.value || getTodayStr();

    const task = {
      id: "t_" + Date.now() + "_" + Math.floor(Math.random() * 10000),
      title,
      category,
      date: dateStr,
      focusMinutes: 0,
      isDone: false,
      isRunning: false,
      startTimeMs: null,
    };
    todoTasks.push(task);
    saveTodos();
    todoTitleInput.value = "";
    renderTodoList();
    renderFocusCalendar();
    renderFocusPie();
  }

  function findTask(id) {
    return todoTasks.find((t) => t.id === id);
  }

  function toggleTodoDone(id) {
    const t = findTask(id);
    if (!t) return;
    t.isDone = !t.isDone;
    saveTodos();
    renderTodoList();
  }

  function deleteTodo(id) {
    todoTasks = todoTasks.filter((t) => t.id !== id);
    saveTodos();
    renderTodoList();
    renderFocusCalendar();
    renderFocusPie();
  }

  function toggleFocus(id) {
    const t = findTask(id);
    if (!t) return;

    if (!t.isRunning) {
      t.isRunning = true;
      t.startTimeMs = Date.now();
    } else {
      const now = Date.now();
      const diffMin = Math.round((now - t.startTimeMs) / 60000);
      if (diffMin > 0) t.focusMinutes += diffMin;
      t.isRunning = false;
      t.startTimeMs = null;
    }
    saveTodos();
    renderTodoList();
    renderFocusCalendar();
    renderFocusPie();
  }

  // 编辑待办：不清空专注时间
  function editTodo(id) {
    const t = findTask(id);
    if (!t) return;

    const newTitle = prompt("修改待办内容：", t.title);
    if (newTitle === null) return;
    const trimmed = newTitle.trim();
    if (trimmed) t.title = trimmed;

    const newCat = prompt(
      "修改分类（直接回车保持原分类）\n可选：学习 / 工作 / 家庭 / 生活 / 娱乐 / 其他",
      t.category
    );
    if (newCat !== null && newCat.trim()) {
      t.category = newCat.trim();
    }

    saveTodos();
    renderTodoList();
    renderFocusCalendar();
    renderFocusPie();
  }

  function renderTodoList() {
    const dateStr = todoDateInput.value || getTodayStr();
    todoDateInput.value = dateStr;

    const list = todoTasks.filter((t) => t.date === dateStr);
    todoListEl.innerHTML = "";

    if (list.length === 0) {
      todoEmptyEl.style.display = "block";
      return;
    }
    todoEmptyEl.style.display = "none";

    list.forEach((t) => {
      const li = document.createElement("li");
      li.className = "todo-item";

      const topRow = document.createElement("div");
      topRow.className = "todo-main-row";

      const main = document.createElement("div");
      main.className = "todo-main";

      const title = document.createElement("div");
      title.className = "todo-title" + (t.isDone ? " done" : "");
      title.textContent = t.title;

      const meta = document.createElement("div");
      const catSpan = document.createElement("span");
      catSpan.className = "badge-category";
      catSpan.textContent = t.category;
      const timeSpan = document.createElement("span");
      timeSpan.className = "todo-meta-text";
      timeSpan.textContent = "专注 " + (t.focusMinutes || 0) + " 分钟";

      meta.appendChild(catSpan);
      meta.appendChild(timeSpan);

      main.appendChild(title);
      main.appendChild(meta);

      const doneRow = document.createElement("div");
      doneRow.className = "done-row";
      const doneCheck = document.createElement("input");
      doneCheck.type = "checkbox";
      doneCheck.checked = t.isDone;
      doneCheck.addEventListener("change", () => toggleTodoDone(t.id));
      const doneLabel = document.createElement("span");
      doneLabel.textContent = "完成";
      doneRow.appendChild(doneCheck);
      doneRow.appendChild(doneLabel);

      topRow.appendChild(main);
      topRow.appendChild(doneRow);

      const actions = document.createElement("div");
      actions.className = "todo-actions-row";

      const editBtn = document.createElement("button");
      editBtn.className = "small-btn edit-btn";
      editBtn.textContent = "编辑";
      editBtn.addEventListener("click", () => editTodo(t.id));

      const focusBtn = document.createElement("button");
      focusBtn.className =
        "small-btn focus-btn" + (t.isRunning ? " stop" : "");
      focusBtn.textContent = t.isRunning ? "结束专注" : "开始专注";
      focusBtn.addEventListener("click", () => toggleFocus(t.id));

      const delBtn = document.createElement("button");
      delBtn.className = "small-btn delete-btn";
      delBtn.textContent = "删除";
      delBtn.addEventListener("click", () => deleteTodo(t.id));

      actions.appendChild(editBtn);
      actions.appendChild(focusBtn);
      actions.appendChild(delBtn);

      li.appendChild(topRow);
      li.appendChild(actions);
      todoListEl.appendChild(li);
    });
  }

  // 专注类别日历
  function renderFocusCalendar() {
    const base = focusCalMonth || new Date();
    const year = base.getFullYear();
    const month = base.getMonth();
    focusCalendarTitleEl.textContent =
      "专注类别日历 · " + year + " 年 " + (month + 1) + " 月";

    const map = {}; // day -> Set(categories)
    todoTasks.forEach((t) => {
      if (!t.date || !t.focusMinutes) return;
      const d = parseYmd(t.date);
      if (d.getFullYear() === year && d.getMonth() === month) {
        const day = d.getDate();
        if (!map[day]) map[day] = new Set();
        map[day].add(t.category);
      }
    });

    const firstDay = new Date(year, month, 1);
    const firstWeekday = firstDay.getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    focusCalendarGridEl.innerHTML = "";

    const weekdays = ["日", "一", "二", "三", "四", "五", "六"];
    weekdays.forEach((w) => {
      const cell = document.createElement("div");
      cell.className = "cal-cell cal-weekday";
      cell.textContent = w;
      focusCalendarGridEl.appendChild(cell);
    });

    for (let i = 0; i < firstWeekday; i++) {
      const empty = document.createElement("div");
      empty.className = "cal-cell cal-empty";
      focusCalendarGridEl.appendChild(empty);
    }

    const categoryColors = {
      学习: "#6366f1",
      工作: "#22c55e",
      家庭: "#f97316",
      生活: "#0ea5e9",
      娱乐: "#ec4899",
      其他: "#6b7280",
    };

    for (let day = 1; day <= daysInMonth; day++) {
      const cell = document.createElement("div");
      cell.className = "cal-cell cal-level-0";

      const num = document.createElement("div");
      num.className = "cal-day-num";
      num.textContent = day;
      cell.appendChild(num);

      const cats = map[day];
      if (cats && cats.size > 0) {
        const bar = document.createElement("div");
        bar.style.display = "flex";
        bar.style.marginTop = "2px";
        bar.style.width = "100%";
        bar.style.height = "6px";

        cats.forEach((cat) => {
          const seg = document.createElement("div");
          seg.style.flex = "1";
          seg.style.borderRadius = "999px";
          seg.style.margin = "0 1px";
          seg.style.background = categoryColors[cat] || "#9ca3af";
          bar.appendChild(seg);
        });

        cell.appendChild(bar);
      }

      // 点击某天 -> 切换上方列表日期
      cell.addEventListener("click", () => {
        const ds =
          year +
          "-" +
          String(month + 1).padStart(2, "0") +
          "-" +
          String(day).padStart(2, "0");
        todoDateInput.value = ds;
        renderTodoList();
      });

      focusCalendarGridEl.appendChild(cell);
    }
  }

  focusCalPrevBtn.addEventListener("click", () => {
    focusCalMonth = shiftMonth(focusCalMonth, -1);
    renderFocusCalendar();
  });
  focusCalNextBtn.addEventListener("click", () => {
    focusCalMonth = shiftMonth(focusCalMonth, 1);
    renderFocusCalendar();
  });

  todoAddBtn.addEventListener("click", addTodo);
  todoTitleInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") addTodo();
  });
  todoDateInput.addEventListener("change", renderTodoList);

  /* ---------------- 专注饼图 ---------------- */
  const pieCanvas = document.getElementById("focus-pie");
  const pieCtx = pieCanvas.getContext("2d");
  const pieLabel = document.getElementById("pie-label");
  const pieLegendEl = document.getElementById("pie-legend");
  const pieWeekBtn = document.getElementById("pie-week-btn");
  const pieMonthBtn = document.getElementById("pie-month-btn");
  const pieYearBtn = document.getElementById("pie-year-btn");
  let pieMode = "week";

  function computePieData(mode) {
    const now = new Date();
    const totals = {};
    todoTasks.forEach((t) => {
      if (!t.focusMinutes || !t.date) return;
      const d = parseYmd(t.date);

      if (mode === "week") {
        const diff = (now - d) / (1000 * 60 * 60 * 24);
        if (diff < 0 || diff > 7) return;
      } else if (mode === "month") {
        if (
          d.getFullYear() !== now.getFullYear() ||
          d.getMonth() !== now.getMonth()
        )
          return;
      } else if (mode === "year") {
        if (d.getFullYear() !== now.getFullYear()) return;
      }

      totals[t.category] = (totals[t.category] || 0) + t.focusMinutes;
    });
    return totals;
  }

  function renderFocusPie() {
    const totals = computePieData(pieMode);
    const cats = Object.keys(totals);
    const sum = cats.reduce((s, c) => s + totals[c], 0);

    pieCtx.clearRect(0, 0, pieCanvas.width, pieCanvas.height);
    if (pieLegendEl) pieLegendEl.innerHTML = "";

    if (!sum) return;

    let start = -Math.PI / 2;
    const colors = {
      学习: "#6366f1",
      工作: "#22c55e",
      家庭: "#f97316",
      生活: "#0ea5e9",
      娱乐: "#ec4899",
      其他: "#6b7280",
    };

    cats.forEach((cat) => {
      const value = totals[cat];
      const angle = (value / sum) * Math.PI * 2;
      pieCtx.beginPath();
      pieCtx.moveTo(pieCanvas.width / 2, pieCanvas.height / 2);
      pieCtx.arc(
        pieCanvas.width / 2,
        pieCanvas.height / 2,
        Math.min(pieCanvas.width, pieCanvas.height) / 2 - 4,
        start,
        start + angle
      );
      pieCtx.closePath();
      pieCtx.fillStyle = colors[cat] || "#9ca3af";
      pieCtx.fill();
      start += angle;
    });

    if (pieLegendEl) {
      cats.forEach((cat) => {
        const item = document.createElement("div");
        item.className = "pie-legend-item";

        const colorBox = document.createElement("span");
        colorBox.className = "pie-legend-color";
        colorBox.style.background = colors[cat] || "#9ca3af";

        const label = document.createElement("span");
        label.textContent = cat + "（" + totals[cat] + " 分钟）";

        item.appendChild(colorBox);
        item.appendChild(label);
        pieLegendEl.appendChild(item);
      });
    }
  }

  pieWeekBtn.addEventListener("click", () => {
    pieMode = "week";
    pieLabel.textContent = "最近一周";
    renderFocusPie();
  });
  pieMonthBtn.addEventListener("click", () => {
    pieMode = "month";
    pieLabel.textContent = "本月";
    renderFocusPie();
  });
  pieYearBtn.addEventListener("click", () => {
    pieMode = "year";
    pieLabel.textContent = "本年";
    renderFocusPie();
  });

  /* ---------------- 每日重要事项 ---------------- */
  const IMPORTANT_STORAGE_KEY = "important_events_v1";
  let importantEvents = []; // {id,date,type,title,note}

  const importantDateInput = document.getElementById("important-date");
  const importantTypeSelect = document.getElementById("important-type");
  const importantTitleInput = document.getElementById("important-title");
  const importantNoteInput = document.getElementById("important-note");
  const importantAddBtn = document.getElementById("important-add-btn");
  const importantListEl = document.getElementById("important-list");
  const importantCalTitleEl = document.getElementById("important-calendar-title");
  const importantCalGridEl = document.getElementById("important-calendar-grid");
  const importantCalPrevBtn = document.getElementById("important-cal-prev");
  const importantCalNextBtn = document.getElementById("important-cal-next");
  let importantCalMonth;

  function loadImportant() {
    try {
      const raw = localStorage.getItem(IMPORTANT_STORAGE_KEY);
      if (raw) importantEvents = JSON.parse(raw) || [];
    } catch (e) {
      importantEvents = [];
    }
  }

  function saveImportant() {
    localStorage.setItem(IMPORTANT_STORAGE_KEY, JSON.stringify(importantEvents));
  }

  function addImportant() {
    const dateStr = importantDateInput.value || getTodayStr();
    const type = importantTypeSelect.value;
    const title = importantTitleInput.value.trim();
    const note = importantNoteInput.value.trim();
    if (!title) return;

    const ev = {
      id: "imp_" + Date.now() + "_" + Math.floor(Math.random() * 10000),
      date: dateStr,
      type,
      title,
      note,
    };
    importantEvents.push(ev);
    saveImportant();
    importantTitleInput.value = "";
    importantNoteInput.value = "";
    renderImportantList(dateStr);
    renderImportantCalendar();
  }

  function renderImportantList(selectedDate) {
    const targetDate = selectedDate || importantDateInput.value || getTodayStr();
    importantDateInput.value = targetDate;
    importantListEl.innerHTML = "";

    const list = importantEvents.filter((e) => e.date === targetDate);
    if (list.length === 0) {
      const li = document.createElement("li");
      li.className = "important-item";
      li.textContent = "这一天还没有重要事项～";
      importantListEl.appendChild(li);
      return;
    }

    list.forEach((e) => {
      const li = document.createElement("li");
      li.className = "important-item";

      const topRow = document.createElement("div");
      topRow.className = "important-top-row";

      const titleSpan = document.createElement("span");
      titleSpan.className = "important-title";
      titleSpan.textContent = e.title;

      const typeSpan = document.createElement("span");
      typeSpan.className = "important-type-badge imp-type-" + e.type;
      typeSpan.textContent = e.type;

      topRow.appendChild(titleSpan);
      topRow.appendChild(typeSpan);

      const noteDiv = document.createElement("div");
      noteDiv.className = "important-note";
      noteDiv.textContent = e.note || "";

      const dateDiv = document.createElement("div");
      dateDiv.className = "important-date";
      dateDiv.textContent = "日期：" + e.date;

      li.appendChild(topRow);
      li.appendChild(noteDiv);
      li.appendChild(dateDiv);
      importantListEl.appendChild(li);
    });
  }

  function renderImportantCalendar() {
    const base = importantCalMonth || new Date();
    const year = base.getFullYear();
    const month = base.getMonth();

    importantCalTitleEl.textContent =
      "重要事项日历 · " + year + " 年 " + (month + 1) + " 月";

    const map = {}; // day -> [types]
    importantEvents.forEach((e) => {
      if (!e.date) return;
      const d = parseYmd(e.date);
      if (d.getFullYear() === year && d.getMonth() === month) {
        const day = d.getDate();
        if (!map[day]) map[day] = [];
        map[day].push(e.type);
      }
    });

    importantCalGridEl.innerHTML = "";

    const weekdays = ["日", "一", "二", "三", "四", "五", "六"];
    weekdays.forEach((w) => {
      const cell = document.createElement("div");
      cell.className = "cal-cell cal-weekday";
      cell.textContent = w;
      importantCalGridEl.appendChild(cell);
    });

    const firstDay = new Date(year, month, 1);
    const firstWeekday = firstDay.getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    for (let i = 0; i < firstWeekday; i++) {
      const empty = document.createElement("div");
      empty.className = "cal-cell cal-empty";
      importantCalGridEl.appendChild(empty);
    }

    const typeColors = {
      生活重要事项: "#f97373",
      姨妈期: "#ec4899",
      固定资金交付日: "#8b5cf6",
      生日: "#facc15",
      纪念日: "#14b8a6",
      工作重要事项: "#3b82f6",
      学业重要事项: "#a855f7",
    };

    for (let day = 1; day <= daysInMonth; day++) {
      const cell = document.createElement("div");
      cell.className = "cal-cell cal-level-0";

      const num = document.createElement("div");
      num.className = "cal-day-num";
      num.textContent = day;
      cell.appendChild(num);

      const types = map[day];
      if (types && types.length > 0) {
        const bar = document.createElement("div");
        bar.style.display = "flex";
        bar.style.marginTop = "2px";
        bar.style.width = "100%";
        bar.style.height = "6px";

        const uniq = Array.from(new Set(types));
        uniq.forEach((type) => {
          const seg = document.createElement("div");
          seg.style.flex = "1";
          seg.style.borderRadius = "999px";
          seg.style.margin = "0 1px";
          seg.style.background = typeColors[type] || "#9ca3af";
          bar.appendChild(seg);
        });

        cell.appendChild(bar);
      }

      cell.addEventListener("click", () => {
        const ds =
          year +
          "-" +
          String(month + 1).padStart(2, "0") +
          "-" +
          String(day).padStart(2, "0");
        renderImportantList(ds);
      });

      importantCalGridEl.appendChild(cell);
    }
  }

  importantAddBtn.addEventListener("click", addImportant);
  importantDateInput.addEventListener("change", () => {
    renderImportantList(importantDateInput.value || getTodayStr());
  });
  importantCalPrevBtn.addEventListener("click", () => {
    importantCalMonth = shiftMonth(importantCalMonth, -1);
    renderImportantCalendar();
  });
  importantCalNextBtn.addEventListener("click", () => {
    importantCalMonth = shiftMonth(importantCalMonth, 1);
    renderImportantCalendar();
  });

  /* ---------------- 体重 & 运动 ---------------- */
  const WEIGHT_STORAGE_KEY = "weight_logs_v1";
  let weightLogs = []; // {id,date,weight,exercise}

  const weightDateInput = document.getElementById("weight-date");
  const weightValueInput = document.getElementById("weight-value");
  const weightExerciseInput = document.getElementById("weight-exercise");
  const weightAddBtn = document.getElementById("weight-add-btn");
  const weightListEl = document.getElementById("weight-list");
  const weightChartCanvas = document.getElementById("weight-chart");
  const weightCtx = weightChartCanvas.getContext("2d");

  function loadWeight() {
    try {
      const raw = localStorage.getItem(WEIGHT_STORAGE_KEY);
      if (raw) weightLogs = JSON.parse(raw) || [];
    } catch (e) {
      weightLogs = [];
    }
  }

  function saveWeight() {
    localStorage.setItem(WEIGHT_STORAGE_KEY, JSON.stringify(weightLogs));
  }

  function addWeight() {
    const dateStr = weightDateInput.value || getTodayStr();
    const weight = parseFloat(weightValueInput.value);
    const exercise = weightExerciseInput.value.trim();
    if (isNaN(weight)) return;

    const log = {
      id: "w_" + Date.now() + "_" + Math.floor(Math.random() * 10000),
      date: dateStr,
      weight,
      exercise,
    };
    weightLogs.push(log);
    saveWeight();
    weightValueInput.value = "";
    weightExerciseInput.value = "";
    renderWeightList();
    renderWeightChart();
  }

  function renderWeightList() {
    const list = [...weightLogs].sort((a, b) => a.date.localeCompare(b.date));
    weightListEl.innerHTML = "";

    if (list.length === 0) {
      const li = document.createElement("li");
      li.className = "weight-item";
      li.textContent = "目前还没有体重记录。";
      weightListEl.appendChild(li);
      return;
    }

    list.forEach((w) => {
      const li = document.createElement("li");
      li.className = "weight-item";
      li.textContent = w.date + " · " + w.weight.toFixed(1) + " kg";
      const meta = document.createElement("div");
      meta.className = "weight-meta";
      meta.textContent = w.exercise || "无特别备注";
      li.appendChild(meta);
      weightListEl.appendChild(li);
    });
  }

  function renderWeightChart() {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();

    const monthLogs = weightLogs
      .filter((w) => {
        const d = parseYmd(w.date);
        return d.getFullYear() === year && d.getMonth() === month;
      })
      .sort((a, b) => a.date.localeCompare(b.date));

    weightCtx.clearRect(0, 0, weightChartCanvas.width, weightChartCanvas.height);
    if (monthLogs.length === 0) return;

    const padding = 20;
    const w = weightChartCanvas.width;
    const h = weightChartCanvas.height;

    const minWeight = Math.min(...monthLogs.map((x) => x.weight));
    const maxWeight = Math.max(...monthLogs.map((x) => x.weight));
    const range = maxWeight - minWeight || 1;
    const stepX = (w - padding * 2) / Math.max(monthLogs.length - 1, 1);

    // 坐标轴
    weightCtx.strokeStyle = "#9ca3af";
    weightCtx.lineWidth = 1;
    weightCtx.beginPath();
    weightCtx.moveTo(padding, padding);
    weightCtx.lineTo(padding, h - padding);
    weightCtx.lineTo(w - padding, h - padding);
    weightCtx.stroke();

    // 折线
    weightCtx.strokeStyle = "#ec4899";
    weightCtx.lineWidth = 2;
    weightCtx.beginPath();

    monthLogs.forEach((log, idx) => {
      const x = padding + stepX * idx;
      const y =
        h -
        padding -
        ((log.weight - minWeight) / range) * (h - padding * 2);

      if (idx === 0) weightCtx.moveTo(x, y);
      else weightCtx.lineTo(x, y);

      weightCtx.fillStyle = "#ec4899";
      weightCtx.beginPath();
      weightCtx.arc(x, y, 3, 0, Math.PI * 2);
      weightCtx.fill();
    });
  }

  weightAddBtn.addEventListener("click", addWeight);

  /* ---------------- 使用说明：刷新按钮 ---------------- */
  const reloadBtn = document.getElementById("force-reload-btn");
  if (reloadBtn) {
    reloadBtn.addEventListener("click", () => {
      window.location.reload();
    });
  }

  /* ---------------- 覆盖 Project50 日历（修正时区） ---------------- */
  // 这里重写 renderP50Calendar，使用 parseYmd，避免日期偏移
  function renderP50Calendar() {
    const base = window.p50CalMonth || new Date();
    const year = base.getFullYear();
    const month = base.getMonth();

    const titleEl = document.getElementById("p50-calendar-title");
    const gridEl = document.getElementById("p50-calendar-grid");
    if (!titleEl || !gridEl) return;

    titleEl.textContent =
      "Project 50 日历 · " + year + " 年 " + (month + 1) + " 月";

    const countByDay = {};
    if (window.p50Data && window.P50_RULES) {
      Object.keys(p50Data).forEach((dateStr) => {
        const d = parseYmd(dateStr);
        if (d.getFullYear() === year && d.getMonth() === month) {
          const day = d.getDate();
          const rules = (p50Data[dateStr] && p50Data[dateStr].rules) || {};
          let c = 0;
          P50_RULES.forEach((r) => {
            if (rules[r.id]) c++;
          });
          countByDay[day] = c;
        }
      });
    }

    const firstDay = new Date(year, month, 1);
    const firstWeekday = firstDay.getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    gridEl.innerHTML = "";

    const weekdays = ["日", "一", "二", "三", "四", "五", "六"];
    weekdays.forEach((w) => {
      const cell = document.createElement("div");
      cell.className = "cal-cell cal-weekday";
      cell.textContent = w;
      gridEl.appendChild(cell);
    });

    for (let i = 0; i < firstWeekday; i++) {
      const empty = document.createElement("div");
      empty.className = "cal-cell cal-empty";
      gridEl.appendChild(empty);
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const cell = document.createElement("div");
      const count = countByDay[day] || 0;
      let levelClass = "cal-level-0";
      if (count >= 7) levelClass = "cal-level-4";
      else if (count >= 5) levelClass = "cal-level-3";
      else if (count >= 3) levelClass = "cal-level-2";
      else if (count >= 1) levelClass = "cal-level-1";

      cell.className = "cal-cell " + levelClass;

      const num = document.createElement("div");
      num.className = "cal-day-num";
      num.textContent = day;

      cell.appendChild(num);
      gridEl.appendChild(cell);
    }
  }

  /* ---------------- 初始化 ---------------- */
  function initApp() {
    const today = getTodayStr();

    const p50DateInput = document.getElementById("p50-date");
    if (p50DateInput) p50DateInput.value = today;
    if (todoDateInput) todoDateInput.value = today;
    if (importantDateInput) importantDateInput.value = today;
    if (weightDateInput) weightDateInput.value = today;

    // 初始化各模块月份
    window.p50CalMonth = new Date();
    window.p50CalMonth.setDate(1);

    focusCalMonth = new Date();
    focusCalMonth.setDate(1);

    importantCalMonth = new Date();
    importantCalMonth.setDate(1);

    // P50 的 load / render 在前一个 <script> 里已经定义
    if (typeof loadP50Data === "function") {
      loadP50Data();
    }

    loadTodos();
    loadImportant();
    loadWeight();

    if (typeof renderP50Day === "function") {
      renderP50Day();
    }
    renderP50Calendar();
    renderTodoList();
    renderFocusCalendar();
    renderFocusPie();
    renderImportantList();
    renderImportantCalendar();
    renderWeightList();
    renderWeightChart();
  }

  // 因为 <script> 在页面底部，DOM 已经加载完毕，可以直接调用
  initApp();
</script>
</div> <!-- .app -->
</body>
</html>

