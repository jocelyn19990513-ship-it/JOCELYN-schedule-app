<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>我的日程清单 · Project 50</title>

  <!-- PWA 图标 & manifest -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="app-icon-project50-512.png" />

  <style>
    *{box-sizing:border-box;}
    body{
      margin:0;padding:16px 0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
        "Helvetica Neue",Arial,"Noto Sans SC",sans-serif;
      background:#f5f5f7;
      display:flex;justify-content:center;align-items:flex-start;
      min-height:100vh;color:#111827;
    }
    .app{
      width:95%;max-width:540px;background:#fff;
      border-radius:20px;
      box-shadow:0 18px 35px rgba(15,23,42,.12);
      padding:18px 18px 20px;
    }
    .app-header{
      padding:4px 2px 10px;
      border-bottom:1px solid #e5e7eb;
      margin-bottom:10px;
    }
    .app-title{
      display:flex;align-items:center;gap:6px;
      font-size:20px;margin:0;
    }
    .app-logo{
      width:22px;height:22px;border-radius:6px;
      background:linear-gradient(135deg,#f9a8d4,#a855f7);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-size:14px;font-weight:600;
    }
    .app-subtitle{
      margin-top:4px;font-size:12px;color:#6b7280;
    }

    /* 顶部 tab，使用 PNG 图标 */
    .tab-header{
      margin-top:10px;margin-bottom:12px;
      padding:4px;
      background:#f3f4f6;border-radius:999px;
      display:flex;gap:6px;
    }
    .tab-btn{
      flex:1;border:none;background:transparent;
      cursor:pointer;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      padding:4px 0;
    }
    .tab-icon-wrap{
      width:30px;height:30px;border-radius:999px;
      background:#fee2f2;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 1px 3px rgba(148,163,184,.5);
    }
    .tab-icon-wrap img{
      width:22px;height:22px;border-radius:50%;
      display:block;
    }
    .tab-btn.active .tab-icon-wrap{
      background:linear-gradient(135deg,#fb7185,#a855f7);
      box-shadow:0 3px 6px rgba(236,72,153,.6);
    }

    .tab-section{display:none;}
    .tab-section.active{display:block;}

    h2.section-title{font-size:16px;margin:0 0 4px;}
    .section-desc{font-size:12px;color:#6b7280;margin-bottom:10px;}
    .hint{font-size:11px;color:#9ca3af;}

    input[type="text"],input[type="date"],input[type="month"],
    input[type="number"],select,textarea{
      width:100%;padding:8px 10px;border-radius:10px;
      border:1px solid #e5e7eb;font-size:14px;outline:none;
      background:#f9fafb;
    }
    input:focus,select:focus,textarea:focus{
      border-color:#ec4899;
      box-shadow:0 0 0 2px rgba(236,72,153,.15);
      background:#fff;
    }
    button{font-family:inherit;}

    .primary-btn{
      border:none;border-radius:999px;
      padding:8px 16px;font-size:13px;
      cursor:pointer;
      background:linear-gradient(135deg,#ec4899,#a855f7);
      color:#fff;white-space:nowrap;
    }
    .primary-btn:active{transform:scale(.97);}
    .small-btn{border-radius:999px;padding:4px 10px;font-size:11px;}
    .badge-soft{
      display:inline-block;padding:2px 8px;border-radius:999px;
      font-size:11px;background:#f3f4f6;color:#4b5563;
    }
    .row-between{
      display:flex;justify-content:space-between;
      align-items:center;gap:8px;
    }

    .card{
      border-radius:14px;padding:10px 10px 12px;
      background:#f9fafb;
      box-shadow:inset 0 0 0 1px #e5e7eb;
      margin-bottom:10px;
    }

    /* Project 50 */
    .p50-date-row{
      display:flex;align-items:center;gap:8px;margin-bottom:8px;
    }
    .p50-date-row input[type="date"]{flex:1;}
    .p50-rules{
      border-radius:12px;background:#fff;padding:6px 8px;
      max-height:220px;overflow-y:auto;
      box-shadow:0 1px 3px rgba(148,163,184,.25);
    }
    .p50-rule-item{
      display:flex;align-items:flex-start;gap:8px;
      padding:6px 0;border-bottom:1px solid #f3f4f6;
    }
    .p50-rule-item:last-child{border-bottom:none;}
    .p50-rule-label{font-size:13px;}
    .p50-summary{font-size:13px;color:#4b5563;margin-top:6px;}
    .p50-note textarea{min-height:70px;resize:vertical;font-size:13px;}

    /* To-Do 输入区 */
    .todo-top-row{display:flex;gap:8px;margin-bottom:8px;}
    .todo-top-row input[type="text"]{flex:2;}
    .todo-top-row select{flex:1.2;}
    .todo-second-row{display:flex;gap:8px;margin-bottom:6px;}
    .todo-second-row input[type="date"]{flex:1;}
    .todo-list{
      list-style:none;padding:0;margin:6px 0 0;
      max-height:230px;overflow-y:auto;
    }
    .todo-empty{
      font-size:13px;color:#9ca3af;text-align:center;margin-top:8px;
    }
    .todo-item{
      padding:7px 6px;border-radius:10px;
      background:#fff;border:1px solid #e5e7eb;
      margin-bottom:6px;
    }
    .todo-top-line{
      display:flex;justify-content:space-between;gap:6px;
      align-items:flex-start;
    }
    .todo-main{flex:1;min-width:0;}
    .todo-title{font-size:14px;word-break:break-word;}
    .todo-title.done{text-decoration:line-through;color:#9ca3af;}
    .todo-meta{
      margin-top:2px;display:flex;flex-wrap:wrap;
      gap:4px;align-items:center;
    }
    .badge-category{
      display:inline-block;padding:2px 8px;border-radius:999px;
      font-size:11px;background:#fee2ff;color:#db2777;
    }
    .todo-meta-text{font-size:11px;color:#6b7280;}
    .todo-done-toggle{
      font-size:11px;color:#4b5563;display:flex;
      align-items:center;gap:4px;white-space:nowrap;
    }
    .todo-actions-row{
      margin-top:6px;display:flex;gap:6px;justify-content:flex-end;
    }
    .focus-btn{border:none;cursor:pointer;background:#ec4899;color:#fff;}
    .focus-btn.stop{background:#a855f7;}
    .delete-btn{border:none;cursor:pointer;background:#ef4444;color:#fff;}

    /* 通用日历 UI */
    .calendar-wrapper{
      margin-top:10px;border-radius:14px;background:#f9fafb;
      padding:8px;box-shadow:inset 0 0 0 1px #e5e7eb;
    }
    .calendar-header{
      display:flex;justify-content:space-between;
      align-items:center;margin-bottom:6px;
    }
    .calendar-title{font-size:13px;color:#4b5563;}
    .cal-nav{display:flex;align-items:center;gap:4px;}
    .cal-nav-btn{
      border:none;border-radius:999px;
      padding:2px 7px;font-size:12px;cursor:pointer;
      background:#e5e7eb;color:#374151;
    }
    .calendar-grid{
      display:grid;grid-template-columns:repeat(7,1fr);
      gap:4px;font-size:11px;
    }
    .cal-cell{
      min-height:32px;border-radius:7px;padding:2px 3px;
      text-align:center;background:#e5e7eb;
      display:flex;flex-direction:column;
      justify-content:flex-start;align-items:center;
    }
    .cal-weekday{
      font-weight:600;background:transparent;color:#6b7280;
    }
    .cal-empty{background:transparent;}
    .cal-day-num{font-size:11px;}

    /* Project 50 日历颜色 */
    .cal-level-0{background:#e5e7eb;color:#4b5563;}
    .cal-level-1{background:#f5f3ff;color:#5b21b6;}
    .cal-level-2{background:#e0e7ff;color:#4338ca;}
    .cal-level-3{background:#c7d2fe;color:#3730a3;}
    .cal-level-4{background:#a855f7;color:#f9fafb;}

    /* To-Do 日历里的类别色条 */
    .focus-cat-row{
      margin-top:2px;display:flex;flex-direction:column;
      width:100%;gap:2px;
    }
    .focus-cat-dot{
      height:4px;border-radius:999px;width:100%;
    }
    .focus-cat-dot-学习{background:#a855f7;}
    .focus-cat-dot-工作{background:#3b82f6;}
    .focus-cat-dot-家庭{background:#ec4899;}
    .focus-cat-dot-生活{background:#f97316;}
    .focus-cat-dot-娱乐{background:#22c55e;}
    .focus-cat-dot-其他{background:#6b7280;}

    /* 体重记录 & 运动 */
    .weight-input-row{
      display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;
    }
    .weight-input-row input[type="date"]{flex:1.1;}
    .weight-input-row input[type="number"]{flex:0.9;}
    .weight-input-row textarea{flex:1 1 100%;min-height:52px;}
    .weight-list{
      margin-top:6px;max-height:150px;overflow-y:auto;
      font-size:13px;color:#4b5563;
    }
    .weight-item{
      display:flex;justify-content:space-between;
      padding:4px 2px;border-bottom:1px solid #e5e7eb;
      gap:6px;
    }
    .weight-empty{
      font-size:13px;color:#9ca3af;margin-top:6px;text-align:center;
    }
    .weight-chart-container{margin-top:8px;}
    .weight-chart-container canvas{
      width:100%;max-height:220px;
    }
    .weight-month-row{
      display:flex;align-items:center;gap:8px;margin-bottom:4px;
      flex-wrap:wrap;
    }
    .exercise-calendar-pill{
      font-size:9px;padding:1px 4px;border-radius:999px;
      background:#f97373;color:#fff;margin-top:2px;
      max-width:100%;white-space:nowrap;
      overflow:hidden;text-overflow:ellipsis;
    }

    /* 重要事项 */
    .important-input-row{
      display:flex;flex-wrap:wrap;gap:8px;margin-bottom:6px;
    }
    .important-input-row>*{flex:1;min-width:0;}
    .-type-badge{
      display:inline-block;padding:1px 6px;border-radius:999px;
      font-size:10px;margin-right:4px;margin-bottom:2px;color:#fff;
    }
    /* 七种重要事项类型的颜色 */
.imp-type-生活重要事项{background:#f97373;}      /* 日常生活类：橙粉色 */
.imp-type-姨妈期{background:#ec4899;}            /* 姨妈期：玫红色 */
.imp-type-固定资金交付日{background:#8b5cf6;}    /* 房租/还款类：紫色 */
.imp-type-生日{background:#facc15;color:#78350f;}/* 生日：黄色 */
.imp-type-纪念日{background:#14b8a6;}            /* 纪念日：蓝绿 */
.imp-type-工作重要事项{background:#3b82f6;}      /* 工作：蓝色 */
.imp-type-学业重要事项{background:#a855f7;}      /* 学业：紫粉色 */
    .imp-pill{
      font-size:9px;padding:1px 4px;border-radius:999px;
      color:#fff;max-width:100%;white-space:nowrap;
      overflow:hidden;text-overflow:ellipsis;margin-top:1px;
    }
    .important-list{
      margin-top:6px;max-height:140px;overflow-y:auto;
      font-size:12px;color:#4b5563;
    }
    .important-item{
      border-bottom:1px solid #e5e7eb;
      padding:4px 0;display:flex;justify-content:space-between;
      gap:6px;
    }

    @media(max-width:400px){
      .todo-top-row,.todo-second-row,.p50-date-row,
      .weight-input-row,.weight-month-row,.important-input-row{
        flex-direction:column;align-items:stretch;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header class="app-header">
    <h1 class="app-title">
      <span class="app-logo">50</span>
      <span>我的日程清单</span>
    </h1>
    <div class="app-subtitle">
      Project 50 打卡 · To-Do 专注 · 重要事项 · 体重 & 运动（数据仅保存在本地）
    </div>
  </header>

  <!-- 顶部 Tab：使用 PNG 小图标 -->
  <div class="tab-header">
    <button class="tab-btn active" data-target="tab-project50" title="Project 50">
      <span class="tab-icon-wrap">
        <img src="icon-project50.png" alt="Project 50" />
      </span>
    </button>
    <button class="tab-btn" data-target="tab-todo" title="待办事项">
      <span class="tab-icon-wrap">
        <img src="icon-todo.png" alt="To-Do" />
      </span>
    </button>
    <button class="tab-btn" data-target="tab-important" title="每日重要事项">
      <span class="tab-icon-wrap">
        <img src="icon-important.png" alt="Important" />
      </span>
    </button>
    <button class="tab-btn" data-target="tab-weight" title="体重记录">
      <span class="tab-icon-wrap">
        <img src="icon-weight.png" alt="Weight" />
      </span>
    </button>
    <button class="tab-btn" data-target="tab-about" title="使用说明">
      <span class="tab-icon-wrap">
        <img src="icon-about.png" alt="About" />
      </span>
    </button>
  </div>

  <!-- Project 50 -->
  <section id="tab-project50" class="tab-section active">
    <div class="card">
      <h2 class="section-title">每日 Challenge</h2>
      <div class="section-desc">
        根据 Project 50（easy 模式）打卡，7 条固定规则，每天复盘自己的执行。
      </div>
      <div class="p50-date-row">
        <input type="date" id="p50-date" />
        <button class="small-btn primary-btn" id="p50-today-btn">跳到今天</button>
      </div>
      <div class="p50-rules" id="p50-rules"></div>
      <div class="p50-summary" id="p50-summary"></div>
    </div>

    <div class="card p50-note">
      <div class="row-between">
        <span class="hint">记录今天的挑战行程 / 感受 / 复盘：</span>
        <span class="badge-soft">仅本地可见</span>
      </div>
      <textarea id="p50-note-input" placeholder="例如：7:30 起床，锻炼 30 分钟，阅读 6 页……"></textarea>
    </div>

    <div class="calendar-wrapper">
      <div class="calendar-header">
        <div class="calendar-title" id="p50-calendar-title">Project 50 日历</div>
        <div class="cal-nav">
          <button class="cal-nav-btn" id="p50-cal-prev">‹</button>
          <button class="cal-nav-btn" id="p50-cal-next">›</button>
        </div>
      </div>
      <div class="hint">色块深浅表示当天完成规则数量，越深完成越多。</div>
      <div class="calendar-grid" id="p50-calendar-grid"></div>
    </div>
  </section>

  <!-- To-Do & 专注 -->
  <section id="tab-todo" class="tab-section">
    <div class="card">
      <h2 class="section-title">待办事项 & 专注记录</h2>
      <div class="section-desc">
        为每天创建待办，按类别管理。点击“开始专注 / 结束专注”记录真实专注时间。
      </div>
      <div class="todo-top-row">
        <input type="text" id="todo-title" placeholder="要做什么？例如：阅读《XXX》5 页" />
        <select id="todo-category">
          <option value="学习">学习</option>
          <option value="工作">工作</option>
          <option value="家庭">家庭</option>
          <option value="生活">生活</option>
          <option value="娱乐">娱乐</option>
          <option value="其他">其他</option>
        </select>
      </div>
      <div class="todo-second-row">
        <input type="date" id="todo-date" />
        <button class="primary-btn" id="todo-add-btn">添加待办</button>
      </div>
      <div class="hint">
        为不同日期添加待办；开始 / 结束专注会累计该任务的专注分钟数。
      </div>
      <ul class="todo-list" id="todo-list"></ul>
      <div class="todo-empty" id="todo-empty">这天还没有待办，可以先添加一条～</div>
    </div>

    <div class="calendar-wrapper">
      <div class="calendar-header">
        <div class="calendar-title" id="focus-calendar-title">专注类别日历</div>
        <div class="cal-nav">
          <button class="cal-nav-btn" id="focus-cal-prev">‹</button>
          <button class="cal-nav-btn" id="focus-cal-next">›</button>
        </div>
      </div>
      <div class="hint">
        每天的色条表示当天有专注的任务类型；点击某一天，可以在上方看到这天的任务列表。
      </div>
      <div class="calendar-grid" id="focus-calendar-grid"></div>
    </div>

    <div class="card">
      <h2 class="section-title">专注时间统计</h2>
      <div class="section-desc">
        统计不同类别在最近一周 / 本月 / 本年的专注时间占比。
      </div>
      <div class="focus-range-row">
        <button class="focus-range-btn active" data-range="week">最近一周</button>
        <button class="focus-range-btn" data-range="month">本月</button>
        <button class="focus-range-btn" data-range="year">本年</button>
      </div>
      <div class="weight-chart-container">
        <canvas id="focus-pie-chart"></canvas>
      </div>
    </div>
  </section>

  <!-- 每日重要事项 -->
  <section id="tab-important" class="tab-section">
    <div class="card">
      <h2 class="section-title">每日重要事项</h2>
      <div class="section-desc">
        为每天添加重要事件，也可以设置固定事件（每月房租日、姨妈期、生日、纪念日等）。
      </div>

      <div class="important-input-row">
        <input type="date" id="important-date" />
        <input type="text" id="important-title" placeholder="事件内容，例如：交房租 / 老公生日" />
      </div>
      <div class="important-input-row">
        <select id="important-type">
  <option value="生活重要事项">生活重要事项</option>
  <option value="姨妈期">姨妈期</option>
  <option value="固定资金交付日">固定资金交付日</option>
  <option value="生日">生日</option>
  <option value="纪念日">纪念日</option>
  <option value="工作重要事项">工作重要事项</option>
  <option value="学业重要事项">学业重要事项</option>
</select>
        <select id="important-repeat">
          <option value="none">不重复</option>
          <option value="monthly">每月重复</option>
          <option value="yearly">每年重复</option>
        </select>
        <input type="number" id="important-duration" min="1" max="10" placeholder="持续天数(可选)" />
      </div>
      <button class="primary-btn" id="important-add-btn">添加重要事项</button>
      <div class="hint" style="margin-top:6px;">
        例：姨妈期可选“姨妈期 + 每月重复 + 持续 5 天”；生日/纪念日选“每年重复”。
      </div>
      <div class="important-list" id="important-list"></div>
    </div>

    <div class="calendar-wrapper">
      <div class="calendar-header">
        <div class="calendar-title" id="important-calendar-title">重要事项日历</div>
        <div class="cal-nav">
          <button class="cal-nav-btn" id="important-cal-prev">‹</button>
          <button class="cal-nav-btn" id="important-cal-next">›</button>
        </div>
      </div>
      <div class="hint">
        每个日期下方会显示彩色小胶囊：不同类型不同颜色，标题会自动截断成小标签。
      </div>
      <div class="calendar-grid" id="important-calendar-grid"></div>
    </div>
  </section>

  <!-- 体重 & 运动 -->
  <section id="tab-weight" class="tab-section">
    <div class="card">
      <h2 class="section-title">体重 & 运动记录</h2>
      <div class="section-desc">
        记录每天的体重和运动内容，并按月份查看折线图与运动日历。
      </div>
      <div class="weight-input-row">
        <input type="date" id="weight-date" />
        <input type="number" id="weight-value" step="0.1" placeholder="体重（kg）" />
        <textarea id="weight-exercise" placeholder="今天运动了什么？例如：慢跑 30 分钟、肩颈拉伸 15 分钟"></textarea>
      </div>
      <button class="primary-btn" id="weight-add-btn">添加记录</button>
      <div class="hint" style="margin-top:6px;">
        建议每天同一时间称重；运动内容会出现在列表与运动日历中。
      </div>
      <div class="weight-list" id="weight-list"></div>
      <div class="weight-empty" id="weight-empty">还没有体重记录，先添加一条吧～</div>
    </div>

    <div class="card">
      <div class="weight-month-row">
        <span class="hint">选择要查看的月份：</span>
        <input type="month" id="weight-month" />
      </div>
      <div class="weight-chart-container">
        <canvas id="weight-chart"></canvas>
      </div>
      <div class="hint" style="margin-top:6px;">
        折线图显示该月每天最后一次记录的体重。下方运动日历可看到每天大概做了什么。
      </div>
    </div>

    <div class="calendar-wrapper">
      <div class="calendar-header">
        <div class="calendar-title" id="exercise-calendar-title">运动内容日历</div>
      </div>
      <div class="calendar-grid" id="exercise-calendar-grid"></div>
    </div>
  </section>

  <!-- 使用说明 -->
  <section id="tab-about" class="tab-section">
    <div class="card">
      <h2 class="section-title">使用说明 ✨</h2>
      <div class="section-desc">
        这是一个个人效率工具：Project 50 打卡、每日待办专注、重要事项、体重 & 运动记录。
        所有数据仅保存在你自己的设备浏览器中。
      </div>

      <div class="row-between" style="margin:6px 0 14px;">
        <p class="hint" style="margin:0;color:#ec4899;">
          ⭐ 版本号 v1.0.2
        </p>
        <button class="small-btn" id="app-reload-btn"
                style="border:none;background:#fdf2f8;color:#be185d;">
          刷新到最新版本
        </button>
      </div>

      <h3 class="section-title">数据 & 隐私</h3>
      <p class="hint">
        ⭐ 所有数据仅存储在本地 localStorage；不同设备、不同人之间不会互相看见。<br>
        ⭐ 更新页面不会清空数据；只有清除浏览器数据或更换设备才会丢失。
      </p>

      <h3 class="section-title" style="margin-top:12px;">添加到手机主屏幕</h3>
      <p class="hint">
        iPhone：Safari 打开→分享→添加到主屏幕。<br>
        安卓：Chrome 打开→右上角菜单“添加到主屏幕 / 安装应用”。
      </p>

      <div style="text-align:center;margin-top:18px;">
        <span style="font-size:12px;color:#ec4899;">
          ✨ Designed by <strong>Jiayu Hou</strong> ✨
        </span>
      </div>
    </div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/***********************
 * 通用工具
 ***********************/
function getTodayStr() {
  const d = new Date();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return d.getFullYear() + "-" + m + "-" + day;
}

/* 不使用 new Date("YYYY-mm-dd")，避免时区导致前一天 bug */
function parseDateLocal(dateStr) {
  if (!dateStr) return new Date(NaN);
  const [y, m, d] = dateStr.split("-").map(Number);
  return new Date(y, m - 1, d);
}

/* 月份偏移 */
function shiftMonth(date, delta) {
  return new Date(date.getFullYear(), date.getMonth() + delta, 1);
}

/***********************
 * Tab 切换
 ***********************/
(function initTabs() {
  const tabButtons = document.querySelectorAll(".tab-btn");
  const sections = document.querySelectorAll(".tab-section");
  tabButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.target;
      tabButtons.forEach((x) => x.classList.remove("active"));
      sections.forEach((x) => x.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(target).classList.add("active");
    });
  });
})();

/***********************
 * Project 50
 ***********************/
const P50_RULES = [
  { id: "wake", text: "早上 8 点前起床" },
  { id: "read", text: "每天阅读书籍至少 5 页" },
  { id: "exercise", text: "每天锻炼至少 30 分钟" },
  { id: "nosoda", text: "不喝碳酸饮料" },
  { id: "morning", text: "完成晨起行程（不玩手机，可听音乐）" },
  { id: "plan", text: "记录今天的计划" },
  { id: "review", text: "简单复盘今天" }
];

const P50_KEY = "p50_data_v3";
let p50Data = {};

const p50DateInput = document.getElementById("p50-date");
const p50RulesEl = document.getElementById("p50-rules");
const p50SummaryEl = document.getElementById("p50-summary");
const p50NoteInput = document.getElementById("p50-note-input");
const p50CalGrid = document.getElementById("p50-calendar-grid");
const p50CalTitle = document.getElementById("p50-calendar-title");
let p50CalMonth = new Date();
p50CalMonth.setDate(1);

function loadP50() {
  const raw = localStorage.getItem(P50_KEY);
  if (raw) {
    try { p50Data = JSON.parse(raw); }
    catch { p50Data = {}; }
  }
}
function saveP50() {
  localStorage.setItem(P50_KEY, JSON.stringify(p50Data));
}
function getP50Day(dateStr) {
  if (!p50Data[dateStr]) {
    p50Data[dateStr] = { rules: {}, note: "" };
  }
  return p50Data[dateStr];
}

function renderP50Day() {
  const dateStr = p50DateInput.value || getTodayStr();
  const day = getP50Day(dateStr);
  p50RulesEl.innerHTML = "";

  let done = 0;
  P50_RULES.forEach(rule => {
    const row = document.createElement("div");
    row.className = "p50-rule-item";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = !!day.rules[rule.id];
    cb.addEventListener("change", () => {
      day.rules[rule.id] = cb.checked;
      saveP50();
      renderP50Calendar();
    });

    const label = document.createElement("div");
    label.className = "p50-rule-label";
    label.textContent = rule.text;

    row.appendChild(cb);
    row.appendChild(label);
    p50RulesEl.appendChild(row);

    if (cb.checked) done++;
  });

  p50SummaryEl.textContent =
    `今日完成情况：${done} / ${P50_RULES.length} 项`;

  p50NoteInput.value = day.note || "";
}

p50NoteInput.addEventListener("input", () => {
  const d = getP50Day(p50DateInput.value);
  d.note = p50NoteInput.value;
  saveP50();
});

/* Project50 日历 */
function renderP50Calendar() {
  const base = p50CalMonth;
  const year = base.getFullYear();
  const month = base.getMonth();
  p50CalTitle.textContent = `Project 50 日历：${year} 年 ${month + 1} 月`;

  const first = new Date(year, month, 1);
  const weekday = first.getDay();
  const days = new Date(year, month + 1, 0).getDate();

  /* 统计完成数量 */
  const countByDay = {};
  Object.keys(p50Data).forEach(dateStr => {
    const d = parseDateLocal(dateStr);
    if (d.getFullYear() === year && d.getMonth() === month) {
      let c = 0;
      P50_RULES.forEach(r => {
        if (p50Data[dateStr].rules[r.id]) c++;
      });
      countByDay[d.getDate()] = c;
    }
  });

  p50CalGrid.innerHTML = "";
  ["日","一","二","三","四","五","六"].forEach(w => {
    const cell = document.createElement("div");
    cell.className = "cal-cell cal-weekday";
    cell.textContent = w;
    p50CalGrid.appendChild(cell);
  });

  for (let i = 0; i < weekday; i++) {
    const cell = document.createElement("div");
    cell.className = "cal-cell cal-empty";
    p50CalGrid.appendChild(cell);
  }

  for (let d = 1; d <= days; d++) {
    let level = "cal-level-0";
    const c = countByDay[d] || 0;
    if (c >= 7) level = "cal-level-4";
    else if (c >= 5) level = "cal-level-3";
    else if (c >= 3) level = "cal-level-2";
    else if (c >= 1) level = "cal-level-1";

    const cell = document.createElement("div");
    cell.className = `cal-cell ${level}`;
    const num = document.createElement("div");
    num.className = "cal-day-num";
    num.textContent = d;
    cell.appendChild(num);

    p50CalGrid.appendChild(cell);
  }
}

document.getElementById("p50-today-btn").addEventListener("click", () => {
  p50DateInput.value = getTodayStr();
  p50CalMonth = new Date();
  p50CalMonth.setDate(1);
  renderP50Day();
  renderP50Calendar();
});
document.getElementById("p50-cal-prev").addEventListener("click", () => {
  p50CalMonth = shiftMonth(p50CalMonth, -1);
  renderP50Calendar();
});
document.getElementById("p50-cal-next").addEventListener("click", () => {
  p50CalMonth = shiftMonth(p50CalMonth, 1);
  renderP50Calendar();
});
p50DateInput.addEventListener("change", renderP50Day);

/***********************
 * To-Do & 专注
 ***********************/
const TODO_KEY = "todo_tasks_v4";
let todoTasks = [];

const todoTitleInput = document.getElementById("todo-title");
const todoCategory = document.getElementById("todo-category");
const todoDateInput = document.getElementById("todo-date");
const todoListEl = document.getElementById("todo-list");
const todoEmptyEl = document.getElementById("todo-empty");

function loadTodos() {
  const raw = localStorage.getItem(TODO_KEY);
  if (raw) {
    try { todoTasks = JSON.parse(raw); }
    catch { todoTasks = []; }
  }
}
function saveTodos() {
  localStorage.setItem(TODO_KEY, JSON.stringify(todoTasks));
}

function addTodo() {
  const title = todoTitleInput.value.trim();
  if (!title) return;

  const dateStr = todoDateInput.value || getTodayStr();
  const t = {
    id: "t_" + Date.now(),
    title,
    category: todoCategory.value,
    date: dateStr,
    focus: 0,
    done: false,
    running: false,
    start: null
  };
  todoTasks.push(t);
  saveTodos();
  todoTitleInput.value = "";
  renderTodoList();
  renderFocusCalendar();
}

document.getElementById("todo-add-btn").addEventListener("click", addTodo);

function toggleDone(id) {
  const t = todoTasks.find(x => x.id === id);
  if (!t) return;
  t.done = !t.done;
  saveTodos();
  renderTodoList();
  renderFocusCalendar();
}

function toggleFocus(id) {
  const t = todoTasks.find(x => x.id === id);
  if (!t) return;

  if (!t.running) {
    t.running = true;
    t.start = Date.now();
  } else {
    const diff = Math.round((Date.now() - t.start) / 60000);
    if (diff > 0) t.focus += diff;
    t.running = false;
    t.start = null;
  }
  saveTodos();
  renderTodoList();
  renderFocusCalendar();
}

function deleteTodo(id) {
  todoTasks = todoTasks.filter(x => x.id !== id);
  saveTodos();
  renderTodoList();
  renderFocusCalendar();
}

function renderTodoList() {
  const dateStr = todoDateInput.value || getTodayStr();
  const list = todoTasks.filter(x => x.date === dateStr);
  todoListEl.innerHTML = "";

  if (list.length === 0) {
    todoEmptyEl.style.display = "block";
    return;
  }
  todoEmptyEl.style.display = "none";

  list.forEach(t => {
    const li = document.createElement("li");
    li.className = "todo-item";

    const top = document.createElement("div");
    top.className = "todo-top-line";

    const main = document.createElement("div");
    main.className = "todo-main";

    const title = document.createElement("div");
    title.className = "todo-title" + (t.done ? " done" : "");
    title.textContent = t.title;

    const meta = document.createElement("div");
    meta.className = "todo-meta";

    const cat = document.createElement("span");
    cat.className = "badge-category";
    cat.textContent = t.category;

    const time = document.createElement("span");
    time.className = "todo-meta-text";
    time.textContent = `专注 ${t.focus} 分钟`;

    meta.appendChild(cat);
    meta.appendChild(time);

    main.appendChild(title);
    main.appendChild(meta);

    const doneToggle = document.createElement("div");
    doneToggle.className = "todo-done-toggle";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = t.done;
    cb.addEventListener("change", () => toggleDone(t.id));

    const label = document.createElement("span");
    label.textContent = "完成";

    doneToggle.appendChild(cb);
    doneToggle.appendChild(label);

    top.appendChild(main);
    top.appendChild(doneToggle);

    /* 下方按钮横排 */
    const row = document.createElement("div");
    row.className = "todo-actions-row";

    const focusBtn = document.createElement("button");
    focusBtn.className = "small-btn focus-btn" + (t.running ? " stop" : "");
    focusBtn.textContent = t.running ? "结束专注" : "开始专注";
    focusBtn.addEventListener("click", () => toggleFocus(t.id));

    const delBtn = document.createElement("button");
    delBtn.className = "small-btn delete-btn";
    delBtn.textContent = "删除";
    delBtn.addEventListener("click", () => deleteTodo(t.id));

    row.appendChild(focusBtn);
    row.appendChild(delBtn);

    li.appendChild(top);
    li.appendChild(row);
    todoListEl.appendChild(li);
  });
}

todoDateInput.addEventListener("change", renderTodoList);

/***********************
 * To-Do 日历（类别）
 ***********************/
const FOCUS_CATEGORIES = ["学习","工作","家庭","生活","娱乐","其他"];
const focusCalGrid = document.getElementById("focus-calendar-grid");
const focusCalTitle = document.getElementById("focus-calendar-title");
let focusCalMonth = new Date();
focusCalMonth.setDate(1);

function renderFocusCalendar() {
  const base = focusCalMonth;
  const year = base.getFullYear();
  const month = base.getMonth();

  focusCalTitle.textContent = `专注类别日历：${year} 年 ${month+1} 月`;

  const first = new Date(year, month, 1);
  const weekday = first.getDay();
  const days = new Date(year, month+1, 0).getDate();

  /* 按天统计类别 */
  const dayCats = {};
  todoTasks.forEach(t => {
    if (!t.focus) return;
    const d = parseDateLocal(t.date);
    if (d.getFullYear()===year && d.getMonth()===month) {
      const day = d.getDate();
      if (!dayCats[day]) dayCats[day] = new Set();
      dayCats[day].add(t.category);
    }
  });

  focusCalGrid.innerHTML = "";
  ["日","一","二","三","四","五","六"].forEach(w=>{
    const cell=document.createElement("div");
    cell.className="cal-cell cal-weekday";
    cell.textContent=w;
    focusCalGrid.appendChild(cell);
  });

  for(let i=0;i<weekday;i++){
    const cell=document.createElement("div");
    cell.className="cal-cell cal-empty";
    focusCalGrid.appendChild(cell);
  }

  for(let d=1;d<=days;d++){
    const cell=document.createElement("div");
    cell.className="cal-cell";

    const num=document.createElement("div");
    num.className="cal-day-num";
    num.textContent=d;
    cell.appendChild(num);

    const cats=dayCats[d];
    if(cats && cats.size>0){
      const row=document.createElement("div");
      row.className="focus-cat-row";
      FOCUS_CATEGORIES.forEach(cat=>{
        if(cats.has(cat)){
          const dot=document.createElement("div");
          dot.className="focus-cat-dot focus-cat-dot-"+cat;
          row.appendChild(dot);
        }
      });
      cell.appendChild(row);
    }

    /* 点击某天 → 查看当天任务 */
    const dateStr = `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    cell.style.cursor="pointer";
    cell.addEventListener("click",()=>{
      todoDateInput.value = dateStr;
      renderTodoList();
      todoListEl.scrollIntoView({behavior:"smooth",block:"start"});
    });

    focusCalGrid.appendChild(cell);
  }
}

document.getElementById("focus-cal-prev").addEventListener("click",()=>{
  focusCalMonth = shiftMonth(focusCalMonth,-1);
  renderFocusCalendar();
});
document.getElementById("focus-cal-next").addEventListener("click",()=>{
  focusCalMonth = shiftMonth(focusCalMonth,1);
  renderFocusCalendar();
});

/***********************
 * 专注饼图（周/月/年）
 ***********************/
const pieCanvas = document.getElementById("focus-pie-chart");
let pieChart = null;

function calcRangeData(range){
  const now = new Date();
  const start = new Date(now);

  if(range==="week"){
    start.setDate(now.getDate()-6);
  } else if(range==="month"){
    start.setDate(1);
  } else if(range==="year"){
    start.setMonth(0); start.setDate(1);
  }

  const sums = {学习:0,工作:0,家庭:0,生活:0,娱乐:0,其他:0};

  todoTasks.forEach(t=>{
    if(!t.focus) return;
    const d = parseDateLocal(t.date);
    if(d>=start && d<=now){
      sums[t.category] += t.focus;
    }
  });

  return sums;
}

function renderPie(range){
  const data = calcRangeData(range);
  const labels = Object.keys(data);
  const values = Object.values(data);

  if(pieChart) pieChart.destroy();

  pieChart = new Chart(pieCanvas,{
    type:"pie",
    data:{
      labels,
      datasets:[{
        data: values,
        backgroundColor:[
          "#a855f7","#3b82f6","#ec4899","#f97316","#22c55e","#6b7280"
        ]
      }]
    },
    options:{
      plugins:{
        legend:{position:"bottom",labels:{font:{size:11}}},
      }
    }
  });
}

document.querySelectorAll(".focus-range-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".focus-range-btn")
      .forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    renderPie(btn.dataset.range);
  });
});
/***********************
 * 每日重要事项
 ***********************/
const IMPORTANT_KEY = "important_v3";
let importantList = [];

const impDateInput = document.getElementById("important-date");
const impTitleInput = document.getElementById("important-title");
const impTypeInput = document.getElementById("important-type");
const impRepeatInput = document.getElementById("important-repeat");
const impDurationInput = document.getElementById("important-duration");
const impListEl = document.getElementById("important-list");
const impCalGrid = document.getElementById("important-calendar-grid");
const impCalTitle = document.getElementById("important-calendar-title");
let impCalMonth = new Date();
impCalMonth.setDate(1);

function loadImportant(){
  const raw = localStorage.getItem(IMPORTANT_KEY);
  if(raw){
    try{ importantList = JSON.parse(raw); }
    catch{ importantList=[]; }
  }
}
function saveImportant(){
  localStorage.setItem(IMPORTANT_KEY, JSON.stringify(importantList));
}

function addImportant(){
  const dateStr = impDateInput.value;
  const title = impTitleInput.value.trim();
  if(!dateStr || !title) return;

  const item = {
    id:"i_"+Date.now(),
    date: dateStr,
    title,
    type: impTypeInput.value,
    repeat: impRepeatInput.value,
    duration: Number(impDurationInput.value || 1)
  };
  importantList.push(item);
  saveImportant();

  impTitleInput.value = "";
  impDurationInput.value = "";
  renderImportantList();
  renderImportantCalendar();
}

document.getElementById("important-add-btn").addEventListener("click", addImportant);

function renderImportantList(){
  impListEl.innerHTML = "";
  if(importantList.length===0){
    impListEl.innerHTML = `<div class="hint" style="text-align:center;margin-top:6px;">暂无重要事项</div>`;
    return;
  }
  importantList.forEach(it=>{
    const row = document.createElement("div");
    row.className="important-item";

    const left = document.createElement("div");
    left.innerHTML =
      `<span class="important-type-badge imp-type-${it.type}">${it.type}</span>`+
      `${it.date} - ${it.title}`;

    const del=document.createElement("button");
    del.textContent="删除";
    del.className="small-btn delete-btn";
    del.addEventListener("click",()=>{
      importantList = importantList.filter(x=>x.id!==it.id);
      saveImportant();
      renderImportantList();
      renderImportantCalendar();
    });

    row.appendChild(left);
    row.appendChild(del);
    impListEl.appendChild(row);
  });
}

/* 重要事项日历 */
function isMatchImportant(it, year, month, day){
  const base = parseDateLocal(it.date);
  let isMatch = false;

  if(it.repeat==="none"){
    isMatch = (base.getFullYear()===year &&
               base.getMonth()===month &&
               base.getDate()===day);
  }
  else if(it.repeat==="monthly"){
    isMatch = (base.getDate()===day);
  }
  else if(it.repeat==="yearly"){
    isMatch = (base.getMonth()===month &&
               base.getDate()===day);
  }
  return isMatch;
}

function renderImportantCalendar(){
  const base=impCalMonth;
  const year=base.getFullYear();
  const month=base.getMonth();

  impCalTitle.textContent = `重要事项日历：${year} 年 ${month+1} 月`;

  const first=new Date(year,month,1);
  const weekday=first.getDay();
  const days=new Date(year,month+1,0).getDate();

  impCalGrid.innerHTML="";
  ["日","一","二","三","四","五","六"].forEach(w=>{
    const c=document.createElement("div");
    c.className="cal-cell cal-weekday";
    c.textContent=w;
    impCalGrid.appendChild(c);
  });

  for(let i=0;i<weekday;i++){
    const c=document.createElement("div");
    c.className="cal-cell cal-empty";
    impCalGrid.appendChild(c);
  }

  for(let d=1;d<=days;d++){
    const cell=document.createElement("div");
    cell.className="cal-cell";

    const num=document.createElement("div");
    num.className="cal-day-num";
    num.textContent=d;
    cell.appendChild(num);

    importantList.forEach(it=>{
      if(isMatchImportant(it,year,month,d)){
        const pill=document.createElement("div");
        pill.className=`imp-pill imp-type-${it.type}`;
        pill.textContent = it.title;
        cell.appendChild(pill);
      }
    });

    impCalGrid.appendChild(cell);
  }
}

document.getElementById("important-cal-prev").addEventListener("click",()=>{
  impCalMonth = shiftMonth(impCalMonth,-1);
  renderImportantCalendar();
});
document.getElementById("important-cal-next").addEventListener("click",()=>{
  impCalMonth = shiftMonth(impCalMonth,1);
  renderImportantCalendar();
});

/***********************
 * 体重与运动
 ***********************/
const WEIGHT_KEY="weight_data_v3";
let weightData=[];

const weightDateInput = document.getElementById("weight-date");
const weightValueInput = document.getElementById("weight-value");
const weightExerciseInput = document.getElementById("weight-exercise");
const weightListEl = document.getElementById("weight-list");
const weightEmptyEl = document.getElementById("weight-empty");
const weightMonthInput = document.getElementById("weight-month");
const weightChartCanvas = document.getElementById("weight-chart");
let weightChart = null;

function loadWeight(){
  const raw = localStorage.getItem(WEIGHT_KEY);
  if(raw){
    try{ weightData = JSON.parse(raw); }
    catch{ weightData=[]; }
  }
}
function saveWeight(){
  localStorage.setItem(WEIGHT_KEY, JSON.stringify(weightData));
}

function addWeight(){
  const dateStr = weightDateInput.value;
  const val = Number(weightValueInput.value);
  const ex = weightExerciseInput.value.trim();
  if(!dateStr || !val) return;

  weightData.push({
    id:"w_"+Date.now(),
    date:dateStr,
    weight:val,
    exercise:ex
  });
  saveWeight();

  weightValueInput.value="";
  weightExerciseInput.value="";
  renderWeightList();
  renderWeightChart();
  renderExerciseCalendar();
}

document.getElementById("weight-add-btn").addEventListener("click", addWeight);

function renderWeightList(){
  weightListEl.innerHTML="";
  if(weightData.length===0){
    weightEmptyEl.style.display="block";
    return;
  }
  weightEmptyEl.style.display="none";

  const sorted=[...weightData].sort((a,b)=>parseDateLocal(b.date)-parseDateLocal(a.date));
  sorted.forEach(item=>{
    const row=document.createElement("div");
    row.className="weight-item";

    const left=document.createElement("div");
    left.innerHTML=`${item.date}：${item.weight} kg`;

    const right=document.createElement("div");
    right.style.fontSize="11px";
    right.textContent=item.exercise || "";

    row.appendChild(left);
    row.appendChild(right);
    weightListEl.appendChild(row);
  });
}

function renderWeightChart(){
  const monthStr = weightMonthInput.value;
  if(!monthStr){
    const d=new Date();
    weightMonthInput.value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    return renderWeightChart();
  }

  const [y,m]=monthStr.split("-").map(Number);
  const year=y, month=m-1;

  /* 找该月每天最后一条记录 */
  const dayMap={};
  weightData.forEach(w=>{
    const d = parseDateLocal(w.date);
    if(d.getFullYear()===year && d.getMonth()===month){
      dayMap[d.getDate()] = w.weight;
    }
  });

  const labels=[];
  const values=[];
  const days=new Date(year,month+1,0).getDate();
  for(let i=1;i<=days;i++){
    labels.push(i);
    values.push(dayMap[i] ?? null);
  }

  if(weightChart) weightChart.destroy();

  weightChart=new Chart(weightChartCanvas,{
    type:"line",
    data:{
      labels,
      datasets:[{
        label:"体重（kg）",
        data:values,
        spanGaps:true,
        borderColor:"#ec4899",
        backgroundColor:"rgba(236,72,153,.2)",
        tension:.3
      }]
    },
    options:{
      scales:{
        x:{ticks:{font:{size:10}}},
        y:{ticks:{font:{size:10}}}
      }
    }
  });
}

weightMonthInput.addEventListener("change",()=>{
  renderWeightChart();
  renderExerciseCalendar();
});

/***********************
 * 体重模块：运动日历
 ***********************/
const exerGrid = document.getElementById("exercise-calendar-grid");

function renderExerciseCalendar(){
  const monthStr=weightMonthInput.value;
  if(!monthStr) return;

  const [y,m]=monthStr.split("-").map(Number);
  const year=y, month=m-1;

  const first=new Date(year,month,1);
  const weekday=first.getDay();
  const days=new Date(year,month+1,0).getDate();

  exerGrid.innerHTML="";
  ["日","一","二","三","四","五","六"].forEach(w=>{
    const c=document.createElement("div");
    c.className="cal-cell cal-weekday";
    c.textContent=w;
    exerGrid.appendChild(c);
  });
  for(let i=0;i<weekday;i++){
    const c=document.createElement("div");
    c.className="cal-cell cal-empty";
    exerGrid.appendChild(c);
  }

  for(let d=1;d<=days;d++){
    const cell=document.createElement("div");
    cell.className="cal-cell";

    const num=document.createElement("div");
    num.className="cal-day-num";
    num.textContent=d;
    cell.appendChild(num);

    /* 找当天运动内容 */
    const list = weightData.filter(x=>{
      const dd=parseDateLocal(x.date);
      return dd.getFullYear()===year && dd.getMonth()===month && dd.getDate()===d;
    });
    if(list.length>0){
      const text=list[list.length-1].exercise || "";
      if(text){
        const pill=document.createElement("div");
        pill.className="exercise-calendar-pill";
        pill.textContent=text;
        cell.appendChild(pill);
      }
    }

    exerGrid.appendChild(cell);
  }
}

/***********************
 * 刷新按钮
 ***********************/
document.getElementById("app-reload-btn")
  .addEventListener("click",()=>location.reload());

/***********************
 * 初始化
 ***********************/
(function init(){
  const today=getTodayStr();

  /* Project 50 */
  p50DateInput.value = today;
  loadP50();
  renderP50Day();
  renderP50Calendar();

  /* To-Do */
  todoDateInput.value = today;
  loadTodos();
  renderTodoList();
  renderFocusCalendar();
  renderPie("week");

  /* 重要事项 */
  loadImportant();
  renderImportantList();
  renderImportantCalendar();

  /* 体重 */
  weightDateInput.value=today;
  loadWeight();
  renderWeightList();

  const now=new Date();
  weightMonthInput.value=
    `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
  renderWeightChart();
  renderExerciseCalendar();
})();
</script>

</body>
</html>
