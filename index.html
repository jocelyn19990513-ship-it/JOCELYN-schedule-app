<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>æˆ‘çš„æ—¥ç¨‹æ¸…å• Â· Project 50</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 16px 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
            "Helvetica Neue", Arial, "Noto Sans SC", sans-serif;
            background: #f5f5f7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: #111827;
        }

        .app {
            width: 95%;
            max-width: 540px;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 18px 35px rgba(15, 23, 42, 0.12);
            padding: 18px 18px 20px;
        }

        .app-header {
            padding: 4px 2px 10px;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 10px;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 20px;
            margin: 0;
        }

        .app-title span.emoji {
            font-size: 20px;
        }

        .app-subtitle {
            margin-top: 4px;
            font-size: 12px;
            color: #6b7280;
        }

        /* tabs */
        .tab-header {
            margin-top: 10px;
            margin-bottom: 12px;
            padding: 3px;
            background: #f3f4f6;
            border-radius: 999px;
            display: flex;
            gap: 4px;
        }

        .tab-btn {
            flex: 1;
            padding: 6px 6px;
            border: none;
            background: transparent;
            font-size: 13px;
            cursor: pointer;
            border-radius: 999px;
            color: #4b5563;
        }

        .tab-btn.active {
            background: #ffffff;
            color: #111827;
            box-shadow: 0 1px 4px rgba(148, 163, 184, 0.4);
            font-weight: 600;
        }

        .tab-section {
            display: none;
        }

        .tab-section.active {
            display: block;
        }

        h2.section-title {
            font-size: 16px;
            margin: 0 0 4px;
        }

        .section-desc {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 10px;
        }

        /* é€šç”¨è¾“å…¥æ ·å¼ */
        input[type="text"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
            outline: none;
            background: #f9fafb;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.18);
            background: #ffffff;
        }

        button {
            font-family: inherit;
        }

        .primary-btn {
            border: none;
            border-radius: 999px;
            padding: 8px 16px;
            font-size: 13px;
            cursor: pointer;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            color: #ffffff;
            white-space: nowrap;
        }

        .primary-btn:active {
            transform: scale(0.97);
        }

        .small-btn {
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 11px;
        }

        .badge-soft {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            background: #f3f4f6;
            color: #4b5563;
        }

        .row-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .hint {
            font-size: 11px;
            color: #9ca3af;
        }

        /* å¡ç‰‡ */
        .card {
            border-radius: 14px;
            padding: 10px 10px 12px;
            background: #f9fafb;
            box-shadow: inset 0 0 0 1px #e5e7eb;
            margin-bottom: 10px;
        }

        /* Project 50 */
        .p50-date-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .p50-date-row input[type="date"] {
            flex: 1;
        }

        .p50-rules {
            border-radius: 12px;
            background: #ffffff;
            padding: 6px 8px;
            max-height: 220px;
            overflow-y: auto;
            box-shadow: 0 1px 3px rgba(148, 163, 184, 0.25);
        }

        .p50-rule-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .p50-rule-item:last-child {
            border-bottom: none;
        }

        .p50-rule-label {
            font-size: 13px;
        }

        .p50-summary {
            font-size: 13px;
            color: #4b5563;
            margin-top: 6px;
        }

        .p50-note textarea {
            min-height: 70px;
            resize: vertical;
            font-size: 13px;
        }

        /* To-Do */
        .todo-top-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .todo-top-row input[type="text"] {
            flex: 2;
        }

        .todo-top-row select {
            flex: 1.3;
        }

        .todo-second-row {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
        }

        .todo-second-row input[type="date"] {
            flex: 1;
        }

        .todo-list {
            list-style: none;
            padding: 0;
            margin: 6px 0 0;
            max-height: 210px;
            overflow-y: auto;
        }

        .todo-empty {
            font-size: 13px;
            color: #9ca3af;
            text-align: center;
            margin-top: 8px;
        }

        .todo-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 7px 2px;
            border-bottom: 1px solid #e5e7eb;
            gap: 6px;
        }

        .todo-main {
            flex: 1;
            min-width: 0;
        }

        .todo-title {
            font-size: 14px;
            word-break: break-word;
        }

        .todo-title.done {
            text-decoration: line-through;
            color: #9ca3af;
        }

        .todo-meta {
            margin-top: 2px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }

        .todo-meta-text {
            font-size: 11px;
            color: #6b7280;
        }

        .badge-category {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            background: #eef2ff;
            color: #4f46e5;
        }

        .todo-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-end;
        }

        .focus-btn {
            border: none;
            cursor: pointer;
            background: #6366f1;
            color: #fff;
        }

        .focus-btn.stop {
            background: #ec4899;
        }

        .delete-btn {
            border: none;
            cursor: pointer;
            background: #ef4444;
            color: #fff;
        }

        .done-row {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #4b5563;
        }

        /* æ—¥å†é€šç”¨ */
        .calendar-wrapper {
            margin-top: 10px;
            border-radius: 14px;
            background: #f9fafb;
            padding: 8px;
            box-shadow: inset 0 0 0 1px #e5e7eb;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .calendar-title {
            font-size: 13px;
            color: #4b5563;
        }

        .cal-nav {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .cal-nav-btn {
            border: none;
            border-radius: 999px;
            padding: 2px 7px;
            font-size: 12px;
            cursor: pointer;
            background: #e5e7eb;
            color: #374151;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            font-size: 11px;
        }

        .cal-cell {
            min-height: 32px;
            border-radius: 7px;
            padding: 2px 3px;
            text-align: center;
            background: #e5e7eb;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .cal-weekday {
            font-weight: 600;
            background: transparent;
            color: #6b7280;
        }

        .cal-empty {
            background: transparent;
        }

        .cal-day-num {
            font-size: 11px;
        }

        .cal-minutes {
            font-size: 10px;
            color: #374151;
        }

        /* ç´«è‰²ç³»ç­‰çº§ï¼š0 æœ€æµ…ï¼Œ4 æœ€æ·± */
        .cal-level-0 { background: #e5e7eb; color: #4b5563; }
        .cal-level-1 { background: #f5f3ff; color: #5b21b6; }
        .cal-level-2 { background: #e0e7ff; color: #4338ca; }
        .cal-level-3 { background: #c7d2fe; color: #3730a3; }
        .cal-level-4 { background: #a855f7; color: #f9fafb; }

        @media (max-width: 400px) {
            .todo-top-row,
            .todo-second-row,
            .p50-date-row {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
<div class="app">
    <header class="app-header">
        <h1 class="app-title">
            <span class="emoji">ğŸ“’</span>
            <span>æˆ‘çš„æ—¥ç¨‹æ¸…å•</span>
        </h1>
        <div class="app-subtitle">
            Project 50 æ‰“å¡ + To-Do ä¸“æ³¨æ—¶é—´ï¼ˆæ—¥å†æŸ¥çœ‹æ‰€æœ‰æœˆä»½ï¼Œæ•°æ®åªä¿å­˜åœ¨æœ¬åœ°ï¼‰
        </div>
    </header>

    <!-- é¡¶éƒ¨ tab -->
    <div class="tab-header">
        <button class="tab-btn active" data-target="tab-project50">Project 50 æ‰“å¡</button>
        <button class="tab-btn" data-target="tab-todo">To-Do & ä¸“æ³¨æ—¥å†</button>
    </div>

    <!-- Project 50 æ¨¡å— -->
    <section id="tab-project50" class="tab-section active">
        <div class="card">
            <h2 class="section-title">æ¯æ—¥ Challenge</h2>
            <div class="section-desc">
                æ ¹æ® Project 50ï¼ˆeasy æ¨¡å¼ï¼‰æ‰“å¡ï¼Œ7 æ¡å›ºå®šè§„åˆ™ï¼Œæ¯å¤©å¤ç›˜è‡ªå·±çš„æ‰§è¡Œã€‚
            </div>

            <div class="p50-date-row">
                <input type="date" id="p50-date" />
                <button class="small-btn primary-btn" id="p50-today-btn">è·³åˆ°ä»Šå¤©</button>
            </div>

            <div class="p50-rules" id="p50-rules"></div>
            <div class="p50-summary" id="p50-summary"></div>
        </div>

        <div class="card p50-note">
            <div class="row-between">
                <span class="hint">è®°å½•ä»Šå¤©çš„æŒ‘æˆ˜è¡Œç¨‹ / æ„Ÿå— / å¤ç›˜ï¼š</span>
                <span class="badge-soft">ä»…æœ¬åœ°å¯è§</span>
            </div>
            <textarea id="p50-note-input" placeholder="ä¾‹å¦‚ï¼š7:30 èµ·åºŠï¼Œé”»ç‚¼ 30 åˆ†é’Ÿï¼Œé˜…è¯» 6 é¡µâ€¦â€¦"></textarea>
        </div>

        <!-- Project50 æ—¥å†æ±‡æ€»ï¼ˆåªç”¨è‰²å—ï¼Œä¸æ˜¾ç¤ºâ€œå‡ é¡¹â€æ•°å­—ï¼‰ -->
        <div class="calendar-wrapper">
            <div class="calendar-header">
                <div class="calendar-title" id="p50-calendar-title">Project 50 å®Œæˆæƒ…å†µ</div>
                <div class="cal-nav">
                    <button class="cal-nav-btn" id="p50-cal-prev">â€¹</button>
                    <button class="cal-nav-btn" id="p50-cal-next">â€º</button>
                </div>
            </div>
            <div class="hint">è‰²å—æ·±æµ…è¡¨ç¤ºå½“å¤©å®Œæˆè§„åˆ™æ•°é‡ï¼Œè¶Šæ·±å®Œæˆè¶Šå¤šã€‚</div>
            <div class="calendar-grid" id="p50-calendar-grid"></div>
        </div>
    </section>

    <!-- To-Do æ¨¡å— -->
    <section id="tab-todo" class="tab-section">
        <div class="card">
            <h2 class="section-title">å¾…åŠäº‹é¡¹ & ä¸“æ³¨è®°å½•</h2>
            <div class="section-desc">
                ä¸ºæ¯å¤©åˆ›å»ºå¾…åŠï¼ŒæŒ‰ç±»åˆ«ç®¡ç†ã€‚ç‚¹å‡»â€œå¼€å§‹ä¸“æ³¨ / ç»“æŸä¸“æ³¨â€è®°å½•çœŸå®ä¸“æ³¨æ—¶é—´ã€‚
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="todo-top-row">
                <input type="text" id="todo-title" placeholder="è¦åšä»€ä¹ˆï¼Ÿä¾‹å¦‚ï¼šé˜…è¯»ã€ŠXXXã€‹5 é¡µ" />
                <select id="todo-category">
                    <option value="å­¦ä¹ ">å­¦ä¹ </option>
                    <option value="å·¥ä½œ">å·¥ä½œ</option>
                    <option value="å®¶åº­">å®¶åº­</option>
                    <option value="ç”Ÿæ´»">ç”Ÿæ´»</option>
                    <option value="å¨±ä¹">å¨±ä¹</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
            <div class="todo-second-row">
                <input type="date" id="todo-date" />
                <button class="primary-btn" id="todo-add-btn">æ·»åŠ å¾…åŠ</button>
            </div>
            <div class="hint">
                ä¸ºä¸åŒæ—¥æœŸæ·»åŠ å¾…åŠï¼›å¼€å§‹ / ç»“æŸä¸“æ³¨ä¼šç´¯è®¡è¯¥ä»»åŠ¡çš„ä¸“æ³¨åˆ†é’Ÿæ•°ã€‚
            </div>

            <!-- åˆ—è¡¨åŒºåŸŸ -->
            <ul class="todo-list" id="todo-list"></ul>
            <div class="todo-empty" id="todo-empty">è¿™å¤©è¿˜æ²¡æœ‰å¾…åŠï¼Œå¯ä»¥å…ˆæ·»åŠ ä¸€æ¡ï½</div>
        </div>

        <!-- ä¸“æ³¨æ—¶é—´æ—¥å† -->
        <div class="calendar-wrapper">
            <div class="calendar-header">
                <div class="calendar-title" id="focus-calendar-title">ä¸“æ³¨æ—¶é—´æ—¥å†</div>
                <div class="cal-nav">
                    <button class="cal-nav-btn" id="focus-cal-prev">â€¹</button>
                    <button class="cal-nav-btn" id="focus-cal-next">â€º</button>
                </div>
            </div>
            <div class="hint">è‰²å—æ·±æµ…è¡¨ç¤ºå½“å¤©ä¸“æ³¨æ€»æ—¶é•¿ï¼ˆæ‰€æœ‰ä»»åŠ¡ä¹‹å’Œï¼‰ã€‚</div>
            <div class="calendar-grid" id="focus-calendar-grid"></div>
        </div>
    </section>
</div>

<script>
    /* å·¥å…·ï¼šè·å–ä»Šå¤© yyyy-mm-dd */
    function getTodayStr() {
        const d = new Date();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return d.getFullYear() + "-" + m + "-" + day;
    }

    /* å·¥å…·ï¼šæŒ‰æœˆåç§» */
    function shiftMonth(date, delta) {
        return new Date(date.getFullYear(), date.getMonth() + delta, 1);
    }

    /* Tab åˆ‡æ¢ */
    (function initTabs() {
        const tabButtons = document.querySelectorAll(".tab-btn");
        const sections = document.querySelectorAll(".tab-section");

        tabButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
                const targetId = btn.dataset.target;
                tabButtons.forEach((b) => b.classList.remove("active"));
                sections.forEach((sec) => sec.classList.remove("active"));
                btn.classList.add("active");
                document.getElementById(targetId).classList.add("active");
            });
        });
    })();

    /* -------------------- Project 50 -------------------- */
    const P50_RULES = [
        { id: "wake", text: "æ—©ä¸Š 8 ç‚¹å‰èµ·åºŠ" },
        { id: "read", text: "æ¯å¤©é˜…è¯»ä¹¦ç±è‡³å°‘ 5 é¡µ" },
        { id: "exercise", text: "æ¯å¤©é”»ç‚¼è‡³å°‘ 30 åˆ†é’Ÿ" },
        { id: "nosoda", text: "ä¸å–ç¢³é…¸é¥®æ–™" },
        { id: "morning_routine", text: "å®Œæˆæ™¨èµ·è¡Œç¨‹ï¼ˆä¸ç©æ‰‹æœºï¼Œä½†å¯ä»¥æ”¾éŸ³ä¹ï¼‰" },
        { id: "plan_day", text: "è®°å½•ä»Šå¤©çš„æŒ‘æˆ˜è¡Œç¨‹ï¼ˆå†™è®¡åˆ’ï¼‰" },
        { id: "reflect", text: "ç®€å•å¤ç›˜ï¼šä»Šå¤©æœ‰æ²¡æœ‰æ¯”æ˜¨å¤©æ›´å¥½ä¸€ç‚¹ï¼Ÿ" }
    ];

    const P50_STORAGE_KEY = "project50_data_v1";
    let p50Data = {}; // { dateStr: { rules:{id:bool}, note:string } }

    const p50DateInput = document.getElementById("p50-date");
    const p50TodayBtn = document.getElementById("p50-today-btn");
    const p50RulesEl = document.getElementById("p50-rules");
    const p50SummaryEl = document.getElementById("p50-summary");
    const p50NoteInput = document.getElementById("p50-note-input");
    const p50CalendarTitleEl = document.getElementById("p50-calendar-title");
    const p50CalendarGridEl = document.getElementById("p50-calendar-grid");
    const p50CalPrevBtn = document.getElementById("p50-cal-prev");
    const p50CalNextBtn = document.getElementById("p50-cal-next");

    let p50CalMonth; // å½“å‰ Project50 æ—¥å†æ˜¾ç¤ºæœˆä»½ï¼ˆæŒ‡å½“æœˆ1æ—¥ï¼‰

    function loadP50Data() {
        const raw = localStorage.getItem(P50_STORAGE_KEY);
        if (raw) {
            try {
                p50Data = JSON.parse(raw) || {};
            } catch {
                p50Data = {};
            }
        }
    }

    function saveP50Data() {
        localStorage.setItem(P50_STORAGE_KEY, JSON.stringify(p50Data));
    }

    function getP50DayData(dateStr) {
        if (!p50Data[dateStr]) {
            p50Data[dateStr] = { rules: {}, note: "" };
        }
        return p50Data[dateStr];
    }

    function renderP50Day() {
        const dateStr = p50DateInput.value || getTodayStr();
        p50DateInput.value = dateStr;

        const dayData = getP50DayData(dateStr);
        const rulesState = dayData.rules || {};
        const note = dayData.note || "";

        p50RulesEl.innerHTML = "";

        let doneCount = 0;
        P50_RULES.forEach((rule) => {
            const item = document.createElement("div");
            item.className = "p50-rule-item";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.checked = !!rulesState[rule.id];

            checkbox.addEventListener("change", () => {
                const d = getP50DayData(p50DateInput.value || getTodayStr());
                d.rules[rule.id] = checkbox.checked;
                saveP50Data();
                renderP50(); // åŒæ—¶åˆ·æ–°æ—¥å†
            });

            if (checkbox.checked) doneCount++;

            const label = document.createElement("div");
            label.className = "p50-rule-label";
            label.textContent = rule.text;

            item.appendChild(checkbox);
            item.appendChild(label);
            p50RulesEl.appendChild(item);
        });

        p50SummaryEl.textContent =
            "ä»Šæ—¥å®Œæˆæƒ…å†µï¼š " +
            doneCount +
            " / " +
            P50_RULES.length +
            " é¡¹æ‰“å¡å·²å®Œæˆã€‚";

        p50NoteInput.value = note;
    }

    function renderP50Calendar() {
        const base = p50CalMonth || new Date();
        const year = base.getFullYear();
        const month = base.getMonth(); // 0â€“11

        p50CalendarTitleEl.textContent =
            "Project 50 æ—¥å† Â· " + year + " å¹´ " + (month + 1) + " æœˆ";

        // ç»Ÿè®¡æœ¬æœˆæ¯å¤©å®Œæˆæ¡æ•°
        const countByDay = {};
        Object.keys(p50Data).forEach((dateStr) => {
            const d = new Date(dateStr);
            if (d.getFullYear() === year && d.getMonth() === month) {
                const day = d.getDate();
                const dayData = p50Data[dateStr];
                const rules = dayData.rules || {};
                let c = 0;
                P50_RULES.forEach((r) => {
                    if (rules[r.id]) c++;
                });
                countByDay[day] = c;
            }
        });

        const firstDay = new Date(year, month, 1);
        const firstWeekday = firstDay.getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        p50CalendarGridEl.innerHTML = "";

        const weekdays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
        weekdays.forEach((w) => {
            const cell = document.createElement("div");
            cell.className = "cal-cell cal-weekday";
            cell.textContent = w;
            p50CalendarGridEl.appendChild(cell);
        });

        for (let i = 0; i < firstWeekday; i++) {
            const empty = document.createElement("div");
            empty.className = "cal-cell cal-empty";
            p50CalendarGridEl.appendChild(empty);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const cell = document.createElement("div");
            const count = countByDay[day] || 0;

            let levelClass = "cal-level-0";
            if (count >= 7) levelClass = "cal-level-4";
            else if (count >= 5) levelClass = "cal-level-3";
            else if (count >= 3) levelClass = "cal-level-2";
            else if (count >= 1) levelClass = "cal-level-1";

            cell.className = "cal-cell " + levelClass;

            const num = document.createElement("div");
            num.className = "cal-day-num";
            num.textContent = day;

            cell.appendChild(num);
            // ä¸å†æ˜¾ç¤ºâ€œå‡ é¡¹â€ï¼Œåªé è‰²å—æ·±æµ…è¡¨ç¤ºå®Œæˆåº¦
            p50CalendarGridEl.appendChild(cell);
        }
    }

    function renderP50() {
        renderP50Day();
        renderP50Calendar();
    }

    p50DateInput.addEventListener("change", () => {
        renderP50Day();
    });

    p50TodayBtn.addEventListener("click", () => {
        p50DateInput.value = getTodayStr();
        p50CalMonth = new Date();
        p50CalMonth.setDate(1);
        renderP50();
    });

    p50NoteInput.addEventListener("input", () => {
        const dateStr = p50DateInput.value || getTodayStr();
        const dayData = getP50DayData(dateStr);
        dayData.note = p50NoteInput.value;
        saveP50Data();
    });

    p50CalPrevBtn.addEventListener("click", () => {
        p50CalMonth = shiftMonth(p50CalMonth, -1);
        renderP50Calendar();
    });

    p50CalNextBtn.addEventListener("click", () => {
        p50CalMonth = shiftMonth(p50CalMonth, 1);
        renderP50Calendar();
    });

    /* -------------------- To-Do & ä¸“æ³¨æ—¥å† -------------------- */
    const TODO_STORAGE_KEY = "todo_tasks_v1";
    let todoTasks = []; // {id,title,category,focusMinutes,date,isDone,isRunning,startTimeMs}

    const todoTitleInput = document.getElementById("todo-title");
    const todoCategorySelect = document.getElementById("todo-category");
    const todoDateInput = document.getElementById("todo-date");
    const todoAddBtn = document.getElementById("todo-add-btn");
    const todoListEl = document.getElementById("todo-list");
    const todoEmptyEl = document.getElementById("todo-empty");

    const focusCalendarTitleEl = document.getElementById("focus-calendar-title");
    const focusCalendarGridEl = document.getElementById("focus-calendar-grid");
    const focusCalPrevBtn = document.getElementById("focus-cal-prev");
    const focusCalNextBtn = document.getElementById("focus-cal-next");

    let focusCalMonth; // å½“å‰ä¸“æ³¨æ—¥å†æ˜¾ç¤ºæœˆä»½

    function loadTodoTasks() {
        const raw = localStorage.getItem(TODO_STORAGE_KEY);
        if (raw) {
            try {
                todoTasks = JSON.parse(raw) || [];
            } catch {
                todoTasks = [];
            }
        }
    }

    function saveTodoTasks() {
        localStorage.setItem(TODO_STORAGE_KEY, JSON.stringify(todoTasks));
    }

    function addTodoTask() {
        const title = todoTitleInput.value.trim();
        if (!title) return;

        const category = todoCategorySelect.value;
        const dateStr = todoDateInput.value || getTodayStr();

        const task = {
            id: "t_" + Date.now() + "_" + Math.floor(Math.random() * 10000),
            title,
            category,
            focusMinutes: 0,
            date: dateStr,
            isDone: false,
            isRunning: false,
            startTimeMs: null
        };

        todoTasks.push(task);
        saveTodoTasks();
        todoTitleInput.value = "";
        renderTodoList();
        renderFocusCalendar();
    }

    function findTaskById(id) {
        return todoTasks.find((t) => t.id === id);
    }

    function toggleTodoDone(id) {
        const t = findTaskById(id);
        if (!t) return;
        t.isDone = !t.isDone;
        saveTodoTasks();
        renderTodoList();
    }

    function deleteTodo(id) {
        todoTasks = todoTasks.filter((t) => t.id !== id);
        saveTodoTasks();
        renderTodoList();
        renderFocusCalendar();
    }

    function toggleFocus(id) {
        const t = findTaskById(id);
        if (!t) return;

        if (!t.isRunning) {
            t.isRunning = true;
            t.startTimeMs = Date.now();
        } else {
            const now = Date.now();
            const diffMin = Math.round((now - t.startTimeMs) / 60000);
            if (diffMin > 0) {
                t.focusMinutes += diffMin;
            }
            t.isRunning = false;
            t.startTimeMs = null;
        }
        saveTodoTasks();
        renderTodoList();
        renderFocusCalendar();
    }

    function renderTodoList() {
        const dateStr = todoDateInput.value || getTodayStr();
        todoDateInput.value = dateStr;

        const dayTasks = todoTasks.filter((t) => t.date === dateStr);
        todoListEl.innerHTML = "";

        if (dayTasks.length === 0) {
            todoEmptyEl.style.display = "block";
            return;
        } else {
            todoEmptyEl.style.display = "none";
        }

        dayTasks.forEach((task) => {
            const li = document.createElement("li");
            li.className = "todo-item";

            const main = document.createElement("div");
            main.className = "todo-main";

            const title = document.createElement("div");
            title.className = "todo-title" + (task.isDone ? " done" : "");
            title.textContent = task.title;

            const meta = document.createElement("div");
            meta.className = "todo-meta";

            const catBadge = document.createElement("span");
            catBadge.className = "badge-category";
            catBadge.textContent = task.category;

            const timeText = document.createElement("span");
            timeText.className = "todo-meta-text";
            const fm = task.focusMinutes || 0;
            timeText.textContent = "ä¸“æ³¨ " + fm + " åˆ†é’Ÿ";

            meta.appendChild(catBadge);
            meta.appendChild(timeText);

            main.appendChild(title);
            main.appendChild(meta);

            const actions = document.createElement("div");
            actions.className = "todo-actions";

            const focusBtn = document.createElement("button");
            focusBtn.className =
                "small-btn focus-btn" + (task.isRunning ? " stop" : "");
            focusBtn.textContent = task.isRunning ? "ç»“æŸä¸“æ³¨" : "å¼€å§‹ä¸“æ³¨";
            focusBtn.addEventListener("click", () => toggleFocus(task.id));

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "small-btn delete-btn";
            deleteBtn.textContent = "åˆ é™¤";
            deleteBtn.addEventListener("click", () => deleteTodo(task.id));

            const doneRow = document.createElement("div");
            doneRow.className = "done-row";
            const doneCheckbox = document.createElement("input");
            doneCheckbox.type = "checkbox";
            doneCheckbox.checked = task.isDone;
            doneCheckbox.addEventListener("change", () =>
                toggleTodoDone(task.id)
            );
            const doneLabel = document.createElement("span");
            doneLabel.textContent = "å®Œæˆ";

            doneRow.appendChild(doneCheckbox);
            doneRow.appendChild(doneLabel);

            actions.appendChild(focusBtn);
            actions.appendChild(deleteBtn);
            actions.appendChild(doneRow);

            li.appendChild(main);
            li.appendChild(actions);
            todoListEl.appendChild(li);
        });
    }

    function renderFocusCalendar() {
        const base = focusCalMonth || new Date();
        const year = base.getFullYear();
        const month = base.getMonth();

        focusCalendarTitleEl.textContent =
            "ä¸“æ³¨æ—¶é—´æ—¥å† Â· " + year + " å¹´ " + (month + 1) + " æœˆ";

        const totalByDay = {}; // day -> minutes
        todoTasks.forEach((t) => {
            if (!t.date || !t.focusMinutes) return;
            const d = new Date(t.date);
            if (d.getFullYear() === year && d.getMonth() === month) {
                const day = d.getDate();
                if (!totalByDay[day]) totalByDay[day] = 0;
                totalByDay[day] += t.focusMinutes;
            }
        });

        const firstDay = new Date(year, month, 1);
        const firstWeekday = firstDay.getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        focusCalendarGridEl.innerHTML = "";

        const weekdays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
        weekdays.forEach((w) => {
            const cell = document.createElement("div");
            cell.className = "cal-cell cal-weekday";
            cell.textContent = w;
            focusCalendarGridEl.appendChild(cell);
        });

        for (let i = 0; i < firstWeekday; i++) {
            const empty = document.createElement("div");
            empty.className = "cal-cell cal-empty";
            focusCalendarGridEl.appendChild(empty);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const cell = document.createElement("div");
            const minutes = totalByDay[day] || 0;

            let levelClass = "cal-level-0";
            if (minutes >= 120) levelClass = "cal-level-4";
            else if (minutes >= 60) levelClass = "cal-level-3";
            else if (minutes >= 30) levelClass = "cal-level-2";
            else if (minutes > 0) levelClass = "cal-level-1";

            cell.className = "cal-cell " + levelClass;

            const num = document.createElement("div");
            num.className = "cal-day-num";
            num.textContent = day;

            const m = document.createElement("div");
            m.className = "cal-minutes";
            m.textContent = minutes > 0 ? minutes + " åˆ†é’Ÿ" : "";

            cell.appendChild(num);
            cell.appendChild(m);
            focusCalendarGridEl.appendChild(cell);
        }
    }

    focusCalPrevBtn.addEventListener("click", () => {
        focusCalMonth = shiftMonth(focusCalMonth, -1);
        renderFocusCalendar();
    });

    focusCalNextBtn.addEventListener("click", () => {
        focusCalMonth = shiftMonth(focusCalMonth, 1);
        renderFocusCalendar();
    });

    /* äº‹ä»¶ & åˆå§‹åŒ– */
    todoAddBtn.addEventListener("click", addTodoTask);
    todoTitleInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") addTodoTask();
    });

    todoDateInput.addEventListener("change", () => {
        renderTodoList();
    });

    (function init() {
        const today = getTodayStr();
        p50DateInput.value = today;
        todoDateInput.value = today;

        p50CalMonth = new Date();
        p50CalMonth.setDate(1);
        focusCalMonth = new Date();
        focusCalMonth.setDate(1);

        loadP50Data();
        loadTodoTasks();
        renderP50();
        renderTodoList();
        renderFocusCalendar();
    })();
</script>
</body>
</html>
